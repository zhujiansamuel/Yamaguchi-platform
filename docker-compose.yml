# Docker Compose 开发环境配置
# 使用方法: docker compose up -d
#
# 特点:
# - 直接复用宿主机已有的 local-pg (postgres:5433)，不再启动 db/pgbouncer
# - Celery workers 可选启动
# - 代码热重载
# - 本地开发更轻量

services:
  # Redis
  redis:
    image: redis:7-alpine
    container_name: ypa_redis
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    networks:
      - ypa_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - ypa_redis_data:/data

  # Django Web 服务 (开发模式 - 使用 runserver 支持热重载)
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_web
    command: >
      sh -c "python3 manage.py collectstatic --noinput &&
             python3 manage.py migrate --noinput &&
             python3 act.py &&
             daphne -b 0.0.0.0 -p 8000 YamagotiProjects.asgi:application"
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DJANGO_DEBUG=True
      - DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,web
      - DJANGO_ENV=dev
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
      - WEB_SCRAPER_API_TOKEN=${WEB_SCRAPER_API_TOKEN}
      - WEB_SCRAPER_WEBHOOK_TOKEN=${WEB_SCRAPER_WEBHOOK_TOKEN}
      - SIMPLEPRO_SECRET_KEY=${SIMPLEPRO_SECRET_KEY}
      - FX_ALPHAVANTAGE_KEY=${FX_ALPHAVANTAGE_KEY}
      - FX_FINNHUB_KEY=${FX_FINNHUB_KEY}
      - FX_TWELVEDATA_KEY=${FX_TWELVEDATA_KEY}
      - EXTERNAL_GOODS_API_URL=${EXTERNAL_GOODS_API_URL}
      - EXTERNAL_GOODS_API_TOKEN=${EXTERNAL_GOODS_API_TOKEN}
      - EXTERNAL_GOODS_CATEGORY_FILTER=${EXTERNAL_GOODS_CATEGORY_FILTER}
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=9000
      - CLICKHOUSE_DB=yamagoti
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "8000:8000"
    networks:
      - ypa_network
    volumes:
      - .:/app
      - ypa_static:/app/staticfiles
      - ypa_media:/app/media
    restart: unless-stopped

  # Celery Worker - 默认队列 (开发时可选)
  worker_default:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_default
    command: celery -A YamagotiProjects worker -Q default,celery -l info -c 2 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - celery  # 使用 --profile celery 启动

  # Celery Worker - PSTA Finalize 专用队列 (开发时可选)
  worker_psta_finalize:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_psta_finalize
    command: celery -A YamagotiProjects worker -Q psta_finalize -l info -c 2 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - celery

  # Celery Worker - PSTA Aggregation 专用队列 (开发时可选)
  worker_psta_aggregation:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_psta_aggregation
    command: celery -A YamagotiProjects worker -Q psta_aggregation -l info -c 4 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - celery

  # Celery Worker - WebScraper 专用队列 (开发时可选)
  worker_webscraper:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_webscraper
    command: celery -A YamagotiProjects worker -Q webscraper -l info -c 2 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - celery
      - shop-workers

  # Celery Worker - Shop1 数据清洗专用队列 (开发时可选)
  worker_shop1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop1
    command: celery -A YamagotiProjects worker -Q shop_shop1 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - celery
      - shop-workers

  # Celery Worker - Shop2 数据清洗专用队列 (开发时可选)
  worker_shop2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop2
    command: celery -A YamagotiProjects worker -Q shop_shop2 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop3 数据清洗专用队列 (开发时可选) - 使用 LLM
  worker_shop3:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop3
    command: celery -A YamagotiProjects worker -Q shop_shop3 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
      # Ollama LLM 配置
      - OLLAMA_URL=http://host.docker.internal:11434
      - OLLAMA_HOST=http://host.docker.internal:11434
      - OLLAMA_MODEL_ID=qwen2.5:7b
      - SHOP3_OLLAMA_URL=http://host.docker.internal:11434
      - SHOP3_OLLAMA_MODEL_ID=qwen2.5:7b
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop4 数据清洗专用队列 (开发时可选) - 使用 LLM
  worker_shop4:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop4
    command: celery -A YamagotiProjects worker -Q shop_shop4 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
      # Ollama LLM 配置
      - OLLAMA_URL=http://host.docker.internal:11434
      - OLLAMA_HOST=http://host.docker.internal:11434
      - OLLAMA_MODEL_ID=qwen2.5:7b
      - SHOP4_OLLAMA_URL=http://host.docker.internal:11434
      - SHOP4_OLLAMA_MODEL_ID=qwen2.5:7b
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop5 数据清洗专用队列 (处理 shop5_1~4, 并发数 2)
  worker_shop5:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop5
    command: celery -A YamagotiProjects worker -Q shop_shop5 -l info -c 2 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop6 数据清洗专用队列 (处理 shop6_1~4, 并发数 2)
  worker_shop6:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop6
    command: celery -A YamagotiProjects worker -Q shop_shop6 -l info -c 2 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop7 数据清洗专用队列 (开发时可选)
  worker_shop7:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop7
    command: celery -A YamagotiProjects worker -Q shop_shop7 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop8 数据清洗专用队列 (开发时可选)
  worker_shop8:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop8
    command: celery -A YamagotiProjects worker -Q shop_shop8 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop9 数据清洗专用队列 (开发时可选) - 使用 LLM
  worker_shop9:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop9
    command: celery -A YamagotiProjects worker -Q shop_shop9 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
      # Ollama LLM 配置
      - OLLAMA_URL=http://host.docker.internal:11434
      - OLLAMA_HOST=http://host.docker.internal:11434
      - OLLAMA_MODEL_ID=qwen2.5:7b
      - SHOP9_OLLAMA_HOST=http://host.docker.internal:11434
      - SHOP9_LX_MODEL_ID=qwen2.5:7b
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop10 数据清洗专用队列 (开发时可选)
  worker_shop10:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop10
    command: celery -A YamagotiProjects worker -Q shop_shop10 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop11 数据清洗专用队列 (开发时可选) - 使用 LLM
  worker_shop11:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop11
    command: celery -A YamagotiProjects worker -Q shop_shop11 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
      # Ollama LLM 配置
      - OLLAMA_URL=http://host.docker.internal:11434
      - OLLAMA_HOST=http://host.docker.internal:11434
      - OLLAMA_MODEL_ID=qwen2.5:7b
      - SHOP11_OLLAMA_MODEL_ID=qwen2.5:7b
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop12 数据清洗专用队列 (开发时可选) - 使用 LLM
  worker_shop12:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop12
    command: celery -A YamagotiProjects worker -Q shop_shop12 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
      # Ollama LLM 配置
      - OLLAMA_URL=http://host.docker.internal:11434
      - OLLAMA_HOST=http://host.docker.internal:11434
      - OLLAMA_MODEL_ID=qwen2.5:7b
      - SHOP12_OLLAMA_MODEL_ID=qwen2.5:7b
      - SHOP12_OLLAMA_HOST=http://host.docker.internal:11434
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop13 数据清洗专用队列 (开发时可选)
  worker_shop13:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop13
    command: celery -A YamagotiProjects worker -Q shop_shop13 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop14 数据清洗专用队列 (开发时可选) - 使用 LLM
  worker_shop14:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop14
    command: celery -A YamagotiProjects worker -Q shop_shop14 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
      # Ollama LLM 配置
      - OLLAMA_URL=http://host.docker.internal:11434
      - OLLAMA_HOST=http://host.docker.internal:11434
      - OLLAMA_MODEL_ID=qwen2.5:7b
      - SHOP14_OLLAMA_URL=http://host.docker.internal:11434
      - SHOP14_LLM_MODEL_ID=qwen2.5:7b
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop15 数据清洗专用队列 (开发时可选) - 使用 LLM
  worker_shop15:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop15
    command: celery -A YamagotiProjects worker -Q shop_shop15 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
      # Ollama LLM 配置
      - OLLAMA_URL=http://host.docker.internal:11434
      - OLLAMA_HOST=http://host.docker.internal:11434
      - OLLAMA_MODEL_ID=qwen2.5:7b
      - SHOP15_OLLAMA_URL=http://host.docker.internal:11434
      - SHOP15_OLLAMA_MODEL=qwen2.5:7b
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop16 数据清洗专用队列 (开发时可选) - 使用 LLM
  worker_shop16:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop16
    command: celery -A YamagotiProjects worker -Q shop_shop16 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
      # Ollama LLM 配置
      - OLLAMA_URL=http://host.docker.internal:11434
      - OLLAMA_HOST=http://host.docker.internal:11434
      - OLLAMA_MODEL_ID=qwen2.5:7b
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop17 数据清洗专用队列 (开发时可选)
  worker_shop17:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop17
    command: celery -A YamagotiProjects worker -Q shop_shop17 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop18 数据清洗专用队列 (开发时可选)
  worker_shop18:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop18
    command: celery -A YamagotiProjects worker -Q shop_shop18 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - Shop20 数据清洗专用队列 (开发时可选)
  worker_shop20:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_shop20
    command: celery -A YamagotiProjects worker -Q shop_shop20 -l info -c 1 --max-tasks-per-child=100
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - shop-workers

  # Celery Worker - AutoML Preprocessing 专用队列 (开发时可选)
  worker_automl_preprocessing:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_automl_preprocessing
    command: celery -A YamagotiProjects worker -Q automl_preprocessing -l info -c 2 --max-tasks-per-child=100
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - celery

  # Celery Worker - AutoML Cause and Effect Testing 专用队列 (开发时可选)
  worker_automl_cause_effect:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_automl_cause_effect
    command: celery -A YamagotiProjects worker -Q automl_cause_effect -l info -c 2 --max-tasks-per-child=100
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - celery

  # Celery Worker - AutoML Quantification of Impact 专用队列 (开发时可选)
  worker_automl_impact:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_worker_automl_impact
    command: celery -A YamagotiProjects worker -Q automl_impact -l info -c 2 --max-tasks-per-child=100
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - celery

  # Celery Beat (开发时可选)
  beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_beat
    command: celery -A YamagotiProjects beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=YamagotiProjects.settings
      - USE_PGBOUNCER=false
      - POSTGRES_HOST=host.docker.internal
      - POSTGRES_PORT=5433
      - POSTGRES_DATABASE=applestockchecker_dev
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=localpass
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - celery  # 使用 --profile celery 启动

  # Flower (开发时可选)
  flower:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ypa_flower
    command: celery -A YamagotiProjects flower --port=5555
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "5555:5555"
    networks:
      - ypa_network
    volumes:
      - .:/app
    restart: unless-stopped
    profiles:
      - celery
      - shop-workers

  # Metabase (数据可视化/验证用)
  metabase:
    image: metabase/metabase:latest
    container_name: ypa_metabase
    ports:
      - "3000:3000"
    environment:
      # Metabase 内部元数据用 H2 (开发足够, 生产可换 PG)
      - MB_DB_TYPE=h2
      - MB_DB_FILE=/metabase-data/metabase.db
      - JAVA_TIMEZONE=Asia/Tokyo
    volumes:
      - ypa_metabase_data:/metabase-data
    networks:
      - ypa_network
    depends_on:
      - clickhouse
    restart: unless-stopped

  # ClickHouse 单节点 (GPU pipeline 用)
  clickhouse:
    image: clickhouse/clickhouse-server:24-alpine
    container_name: ypa_clickhouse
    ports:
      - "9000:9000"    # Native TCP (clickhouse-driver)
      - "8123:8123"    # HTTP (备用/调试)
    volumes:
      - ypa_clickhouse_data:/var/lib/clickhouse
      - ./AppleStockChecker/clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      - CLICKHOUSE_DB=yamagoti
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=
    networks:
      - ypa_network
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

volumes:
  ypa_redis_data:
    driver: local
  ypa_static:
    driver: local
  ypa_media:
    driver: local
  ypa_clickhouse_data:
    driver: local
  ypa_metabase_data:
    driver: local

networks:
  ypa_network:
    driver: bridge
