<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>最近2天所有机种PSTA原始数据（时间对齐）</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Microsoft YaHei,Segoe UI Emoji,Segoe UI Symbol,sans-serif;background:#fafafa;color:#111;margin:0}
    .wrap{max-width:1400px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin-bottom:20px}
    .header{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin-bottom:20px;position:sticky;top:0;z-index:100}
    .chart-container{margin-bottom:32px}
    .chart-title{font-size:16px;font-weight:600;color:#111;margin-bottom:8px;padding:8px 0}
    .chart-subtitle{font-size:14px;font-weight:500;color:#374151;margin-top:16px;margin-bottom:8px;padding:8px 0;border-top:1px solid #e5e7eb}
    .chart-meta{font-size:12px;color:#6b7280;margin-bottom:8px}
    .loading{text-align:center;padding:40px;font-size:14px;color:#6b7280}
    .error{text-align:center;padding:40px;font-size:14px;color:#ef4444}
    button{padding:9px 14px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer;font-size:14px}
    button:hover{background:#333}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    input[type=number]{width:80px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;outline:0;background:#fff}
    .badge{display:inline-block;padding:4px 8px;border-radius:6px;font-size:11px;background:#e5e7eb;color:#6b7280;margin-left:8px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h2 style="margin:0 0 12px 0">最近2天所有机种PSTA原始数据 <span class="badge">时间对齐</span></h2>
    <div class="controls">
      <label style="display:flex;gap:6px;align-items:center">
        天数: <input id="daysInput" type="number" min="1" max="7" value="2"/>
      </label>
      <label style="display:flex;gap:6px;align-items:center">
        <input id="showPoints" type="checkbox"/> 显示点
      </label>
      <button id="refreshBtn">刷新</button>
    </div>
    <div id="summary" style="margin-top:8px;font-size:12px;color:#6b7280"></div>
  </div>

  <div id="loading" class="loading">正在加载PSTA数据...</div>
  <div id="error" class="error" style="display:none"></div>
  <div id="charts"></div>
</div>

<script>
const API_BASE = "/AppleStockChecker";

// 店铺颜色规则（固定颜色方案）
const SHOP_COLOR_RULES = [
    {match: /買取商店/, color: "#DD1133", shop_id: 14, order: 1},
    {match: /海峡通信/, color: "#478CD8", shop_id: 1, order: 2},
    {match: /買取一丁目/, color: "#B41524", shop_id: 8, order: 3},
    {match: /モバイルミックス/, color: "#DD1133", shop_id: 13, order: 4},
    {match: /森森買取/, color: "#278C46", shop_id: 7, order: 5},
    {match: /買取ルデヤ/, color: "#2DA9E8", shop_id: 9, order: 6},
    {match: /買取wiki/, color: "#E71534", shop_id: 10, order: 7},
    {match: /買取ホムラ/, color: "#F27474", shop_id: 19, order: 8},
    {match: /ドラゴンモバイル/, color: "#3952A6", shop_id: 16, order: 9},
    {match: /モバステ/, color: "#E60012", shop_id: 18, order: 10},
    {match: /アキモバ/, color: "#20AECC", shop_id: 12, order: 11},
    {match: /トゥインクル/, color: "#0EC7D9", shop_id: 17, order: 12},
    {match: /家電市場/, color: "#FFF100", shop_id: 3, order: 13},
    {match: /買取楽園/, color: "#DA7C66", shop_id: 4, order: 14},
    {match: /買取当番/, color: "#1C4473", shop_id: 2, order: 15},
    {match: /携帯空間/, color: "#0049A8", shop_id: 5, order: 16},
    {match: /ゲストモバイル/, color: "#34C6F6", shop_id: 11, order: 17},
    {match: /買取オク/, color: "#033F68", shop_id: 6, order: 18},
    {match: /毎日買取/, color: "#C30D23", shop_id: 15, order: 19},
    {match: /Mobile Zone/, color: "#f50620", shop_id: 20, order: 20},
];

// 备用调色板（如果店铺不在规则中）
const PALETTE = [
  "#2563eb","#16a34a","#f59e0b","#ef4444","#8b5cf6",
  "#06b6d4","#a855f7","#f97316","#22c55e","#3b82f6",
  "#e11d48","#14b8a6","#7c3aed","#0ea5e9","#84cc16",
  "#ec4899","#10b981","#f43f5e","#6366f1","#14b8a6"
];

// 根据店铺名称获取颜色
function getShopColor(shopName) {
  const rule = SHOP_COLOR_RULES.find(r => r.match.test(shopName));
  return rule ? rule.color : null;
}

// 根据店铺名称获取排序顺序
function getShopOrder(shopName) {
  const rule = SHOP_COLOR_RULES.find(r => r.match.test(shopName));
  return rule ? rule.order : 999;
}

let charts = {};  // 存储所有图表实例

// 认证与拉取
function handleAuth(resp){
  if (resp.status === 401 || resp.status === 403 || (resp.redirected && resp.url.includes("/accounts/login"))){
    const next = encodeURIComponent(location.pathname + location.search);
    location.href = `/accounts/login/?next=${next}`;
    return false;
  }
  return true;
}

async function fetchJSON(url){
  const r = await fetch(url, {credentials:"same-origin"});
  if(!handleAuth(r)) throw new Error("未登录");
  if(!r.ok) throw new Error(`请求失败：${r.status}`);
  return r.json();
}

// 绘制单个图表
function drawChart(containerId, pn, iphoneLabel, datasets, showPoints){
  const canvas = document.createElement('canvas');
  canvas.height = 300;
  containerId.appendChild(canvas);

  // 按店铺顺序排序 datasets
  const sortedDatasets = datasets.sort((a, b) => {
    return getShopOrder(a.label) - getShopOrder(b.label);
  });

  const dsLines = sortedDatasets.map((ds,i)=>{
    // 优先使用固定颜色，如果没有则使用备用调色板
    const shopColor = getShopColor(ds.label);
    const color = shopColor || PALETTE[i % PALETTE.length];

    return {
      label: ds.label,
      data:  ds.data.map(p=>({x:new Date(p.x), y:p.y})),
      borderColor: color,
      backgroundColor: color,
      borderWidth: 2,
      pointRadius: showPoints ? 3 : 0,
      spanGaps: true,
      tension: 0.2
    };
  });

  const chart = new Chart(canvas, {
    type: 'line',
    data: { datasets: dsLines },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: {
          type: 'time',
          time: { unit: 'hour' },
          title: { display: true, text: 'Timestamp_Time（对齐后）' }
        },
        y: {
          beginAtZero: false,
          title: { display: true, text: '价格（円）' }
        }
      },
      plugins: {
        legend: {
          position: 'top',
          labels: { boxWidth: 12, padding: 8, font: { size: 11 } }
        },
        tooltip: {
          callbacks: {
            label: it => `${it.dataset.label}: ¥${Number(it.parsed.y).toLocaleString()}`
          }
        }
      }
    }
  });

  charts[pn] = chart;
}

// 绘制 logb 指标图表
function drawLogbChart(containerId, pn, iphoneLabel, logbDatasets, showPoints){
  const canvas = document.createElement('canvas');
  canvas.height = 250;
  containerId.appendChild(canvas);

  // logb 调色板（区分 WMA 版本）
  const logbPalette = [
    "#2563eb", "#16a34a", "#f59e0b", "#ef4444", "#8b5cf6",
    "#06b6d4", "#a855f7", "#f97316", "#22c55e", "#3b82f6"
  ];

  const dsLines = logbDatasets.map((ds, i) => {
    const color = logbPalette[i % logbPalette.length];
    return {
      label: ds.label,
      data: ds.data.map(p => ({ x: new Date(p.x), y: p.y })),
      borderColor: color,
      backgroundColor: color,
      borderWidth: 2,
      pointRadius: showPoints ? 3 : 0,
      spanGaps: true,
      tension: 0.2
    };
  });

  const chart = new Chart(canvas, {
    type: 'line',
    data: { datasets: dsLines },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: {
          type: 'time',
          time: { unit: 'hour' },
          title: { display: true, text: 'Timestamp（对齐后）' }
        },
        y: {
          beginAtZero: false,
          title: { display: true, text: 'Log Premium（log(市场价/官方价)）' }
        }
      },
      plugins: {
        legend: {
          position: 'top',
          labels: { boxWidth: 12, padding: 8, font: { size: 11 } }
        },
        tooltip: {
          callbacks: {
            label: it => `${it.dataset.label}: ${Number(it.parsed.y).toFixed(7)}`
          }
        }
      }
    }
  });

  charts[`${pn}_logb`] = chart;
}

// 获取 logb 数据
async function fetchLogbData(iphoneId, startISO, endISO) {
  try {
    // 查询 FeatureSnapshot: name="logb", scope="shopcohort:full_store|iphone:{iphoneId}"
    const scope = `shopcohort:full_store|iphone:${iphoneId}`;
    const params = new URLSearchParams({
      name: 'logb',
      scope: scope,
      bucket__gte: startISO,
      bucket__lte: endISO,
      ordering: 'bucket',
      page_size: 10000
    });

    const resp = await fetchJSON(`${API_BASE}/features/?${params.toString()}`);
    const records = resp.results || resp || [];

    // 按 version 分组
    const dataByVersion = new Map();
    records.forEach(r => {
      const version = r.version || 'unknown';
      if (!dataByVersion.has(version)) {
        dataByVersion.set(version, []);
      }
      dataByVersion.get(version).push({
        x: r.bucket,
        y: r.value
      });
    });

    // 转换为 datasets 格式
    return Array.from(dataByVersion.entries()).map(([version, points]) => ({
      label: version,
      data: points
    }));
  } catch (e) {
    console.warn(`获取 logb 数据失败 (iphone ${iphoneId}):`, e);
    return [];
  }
}

// 主流程
async function loadAllCharts(){
  const days = Math.max(1, parseInt(document.getElementById('daysInput').value || '2', 10));
  const showPoints = document.getElementById('showPoints').checked;

  document.getElementById('loading').style.display = 'block';
  document.getElementById('error').style.display = 'none';
  document.getElementById('charts').innerHTML = '';
  document.getElementById('summary').textContent = '';

  // 销毁旧图表
  Object.values(charts).forEach(c => c.destroy());
  charts = {};

  try {
    // 1. 获取所有机型
    const iphonesResp = await fetchJSON(`${API_BASE}/options/iphones/`);
    const iphones = iphonesResp || [];

    if (iphones.length === 0) {
      throw new Error("未找到机型数据");
    }

    // 2. 计算时间范围（使用 start 和 end 参数）
    const now = new Date();
    const start = new Date(now.getTime() - days*24*60*60*1000);

    // 格式化为 ISO 字符串
    const startISO = start.toISOString();
    const endISO = now.toISOString();

    // 3. 获取所有PSTA价格数据（一次性请求，使用 start/end）
    const params = new URLSearchParams({
      start: startISO,
      end: endISO,
      ordering: 'Timestamp_Time',
      page_size: 100000  // 大量数据
    });

    const priceResp = await fetchJSON(`${API_BASE}/purchasing-time-analyses-psta-compact/?${params.toString()}`);
    const allRecords = priceResp.results || priceResp || [];

    if (allRecords.length === 0) {
      throw new Error("未找到PSTA数据");
    }

    // 4. 按 part_number (iphone字段) 分组数据
    const dataByPN = new Map();
    // 同时创建一个 iphone ID 和 label 的映射
    const iphoneMap = new Map();  // part_number -> label
    const iphoneIdMap = new Map();  // part_number -> id
    iphones.forEach(iph => {
      iphoneMap.set(iph.part_number, iph.label);
      iphoneIdMap.set(iph.part_number, iph.id);
    });

    allRecords.forEach(r => {
      const pn = r.iphone;  // 这是 part_number (根据 PSTACompactSerializer)
      if (!pn) return;

      if (!dataByPN.has(pn)) {
        dataByPN.set(pn, {
          label: iphoneMap.get(pn) || pn,
          shopData: new Map()  // shop_name -> [{x,y}]
        });
      }

      const pnData = dataByPN.get(pn);
      const shopName = r.shop || `Shop#${r.shop_id}`;  // shop 是店铺名称

      if (!pnData.shopData.has(shopName)) {
        pnData.shopData.set(shopName, []);
      }

      pnData.shopData.get(shopName).push({
        x: r.Timestamp_Time,  // PSTA使用 Timestamp_Time（对齐后的时间）
        y: r.New_Product_Price
      });
    });

    // 5. 为每个 part_number 创建图表（按 part_number 排序）
    const chartsContainer = document.getElementById('charts');
    let chartCount = 0;

    // 转换为数组并按 part_number 排序
    const sortedPNs = Array.from(dataByPN.entries()).sort((a, b) => {
      return a[0].localeCompare(b[0]);  // 按 part_number 字母顺序排序
    });

    for (const [pn, pnData] of sortedPNs) {
      const chartDiv = document.createElement('div');
      chartDiv.className = 'chart-container';

      const title = document.createElement('div');
      title.className = 'chart-title';
      title.textContent = `${pnData.label}`;

      const meta = document.createElement('div');
      meta.className = 'chart-meta';
      const totalPoints = Array.from(pnData.shopData.values()).reduce((sum, arr) => sum + arr.length, 0);
      meta.textContent = `店铺数: ${pnData.shopData.size} | 数据点: ${totalPoints}`;

      // 价格图表容器
      const priceCanvasContainer = document.createElement('div');
      priceCanvasContainer.style.height = '300px';
      priceCanvasContainer.style.position = 'relative';

      chartDiv.appendChild(title);
      chartDiv.appendChild(meta);
      chartDiv.appendChild(priceCanvasContainer);

      // 构造价格 datasets
      const datasets = Array.from(pnData.shopData.entries()).map(([shopName, points]) => ({
        label: shopName,
        data: points
      }));

      drawChart(priceCanvasContainer, pn, pnData.label, datasets, showPoints);
      chartCount++;

      // ========== 添加 logb 图表 ==========
      const iphoneId = iphoneIdMap.get(pn);
      if (iphoneId) {
        // 获取 logb 数据
        const logbDatasets = await fetchLogbData(iphoneId, startISO, endISO);

        if (logbDatasets.length > 0) {
          // 添加 logb 图表标题
          const logbSubtitle = document.createElement('div');
          logbSubtitle.className = 'chart-subtitle';
          logbSubtitle.textContent = `市场 Log 溢价 (Market Log Premium)`;
          chartDiv.appendChild(logbSubtitle);

          const logbMeta = document.createElement('div');
          logbMeta.className = 'chart-meta';
          const totalLogbPoints = logbDatasets.reduce((sum, ds) => sum + ds.data.length, 0);
          logbMeta.textContent = `WMA 版本数: ${logbDatasets.length} | 数据点: ${totalLogbPoints}`;
          chartDiv.appendChild(logbMeta);

          // logb 图表容器
          const logbCanvasContainer = document.createElement('div');
          logbCanvasContainer.style.height = '250px';
          logbCanvasContainer.style.position = 'relative';
          chartDiv.appendChild(logbCanvasContainer);

          drawLogbChart(logbCanvasContainer, pn, pnData.label, logbDatasets, showPoints);
        }
      }

      chartsContainer.appendChild(chartDiv);
    }

    document.getElementById('summary').textContent =
      `已加载 ${chartCount} 个机型（PSTA时间对齐），共 ${allRecords.length} 条记录`;
    document.getElementById('loading').style.display = 'none';

  } catch(e) {
    console.error(e);
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
    document.getElementById('error').textContent = `加载失败：${e.message || e}`;
  }
}

// 事件监听
document.getElementById('refreshBtn').addEventListener('click', loadAllCharts);

// 页面加载时自动运行
window.addEventListener('DOMContentLoaded', loadAllCharts);
</script>
</body>
</html>
