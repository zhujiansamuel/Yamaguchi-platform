<!doctype html>
<html lang="zh">
<head>
    <meta charset="utf-8"/>
    <title>AutoML Analysis Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- MathJax for LaTeX rendering -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Chart.js for Heatmap -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1"></script>

    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #8b5cf6;
            --bg-color: #f9fafb;
            --card-bg: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "PingFang SC", "Hiragino Sans", "Noto Sans CJK JP", Roboto, Arial;
            background-color: var(--bg-color);
            color: var(--text-primary);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 32px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .controls {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .controls h2 {
            font-size: 20px;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .task-button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .task-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .task-button:active {
            transform: translateY(0);
        }

        .task-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .task-button.secondary {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .task-button.secondary:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .status-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .status-message.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .status-message.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .status-message.info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .results-section {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .results-section h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .summary-card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--primary-color);
        }

        .summary-card h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .summary-card p {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .interpretation-box {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05));
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
        }

        .interpretation-box h3 {
            color: var(--primary-color);
            margin-bottom: 12px;
        }

        .interpretation-box ul {
            margin-left: 24px;
        }

        .interpretation-box li {
            margin-bottom: 8px;
        }

        .chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 32px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 24px;
        }

        table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        table tr:hover {
            background-color: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.high {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .badge.medium {
            background-color: #fef3c7;
            color: #92400e;
        }

        .badge.low {
            background-color: #d1fae5;
            color: #065f46;
        }

        /* Mathematical Model Section Styles */
        .math-section {
            background: var(--card-bg);
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }

        .math-section details {
            margin-bottom: 16px;
        }

        .math-section summary {
            cursor: pointer;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
        }

        .math-section summary:hover {
            opacity: 0.9;
        }

        .math-content {
            padding: 24px 16px;
        }

        .math-section h2 {
            font-size: 28px;
            margin-bottom: 24px;
            color: var(--text-primary);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 12px;
        }

        .math-section h3 {
            font-size: 22px;
            margin-top: 32px;
            margin-bottom: 16px;
            color: var(--primary-color);
        }

        .math-section h4 {
            font-size: 18px;
            margin-top: 24px;
            margin-bottom: 12px;
            color: var(--secondary-color);
        }

        .math-section p {
            margin-bottom: 16px;
            line-height: 1.8;
        }

        .math-section ul {
            margin-left: 24px;
            margin-bottom: 16px;
        }

        .math-section li {
            margin-bottom: 8px;
        }

        .formula-block {
            background: #f8fafc;
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            overflow-x: auto;
        }

        .highlight-box {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
        }

        .highlight-box h4 {
            margin-top: 0;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 24px;
            }

            .math-section {
                padding: 20px;
            }

            .math-section h2 {
                font-size: 24px;
            }

            .math-section h3 {
                font-size: 20px;
            }

            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AutoML Analysis Dashboard</h1>
            <p>Machine Learning and Deep Learning Results Visualization - å¤šåº—é“ºÃ—å¤šæœºç§Ã—æ—¶é—´çš„å› æœåˆ†æç³»ç»Ÿ</p>
        </header>

        <div class="controls">
            <h2>ğŸ¯ Analysis Configuration</h2>

            <div id="statusMessage" class="status-message"></div>

            <div class="form-row">
                <div class="form-group">
                    <label for="iphoneSelect">é€‰æ‹©æœºå‹ (iPhone Model):</label>
                    <select id="iphoneSelect">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="daysSelect">åˆ†æçª—å£ (Time Window):</label>
                    <select id="daysSelect">
                        <option value="3">3 å¤©</option>
                        <option value="7" selected>7 å¤©</option>
                        <option value="14">14 å¤©</option>
                        <option value="30">30 å¤©</option>
                    </select>
                </div>
            </div>

            <div class="button-group">
                <button class="task-button" onclick="analyzeSingle()">
                    ğŸ” åˆ†æé€‰ä¸­æœºå‹
                </button>
                <button class="task-button secondary" onclick="analyzeAll()">
                    ğŸš€ æ‰¹é‡åˆ†æå…¨éƒ¨æœºå‹
                </button>
                <button class="task-button" onclick="viewResults()">
                    ğŸ“Š æŸ¥çœ‹å†å²ç»“æœ
                </button>
            </div>
        </div>

        <!-- Sliding Window Analysis Configuration -->
        <div class="controls">
            <h2>â±ï¸ æ»‘åŠ¨æ—¶é—´çª—å£åˆ†æ (Sliding Window Analysis)</h2>

            <p style="margin-bottom: 16px; color: var(--text-secondary);">
                åˆ›å»ºå¤šä¸ªæ—¶é—´çª—å£çš„åˆ†æä»»åŠ¡ï¼Œè¿½è¸ªå› æœå…³ç³»éšæ—¶é—´çš„æ¼”åŒ–ã€‚é»˜è®¤å‚æ•°ï¼šæ€»æ—¶é•¿ 30 å¤©ï¼Œçª—å£å¤§å° 3 å¤©ï¼Œæ­¥é•¿ 6 å°æ—¶ã€‚
            </p>

            <div class="form-row">
                <div class="form-group">
                    <label for="slidingIphoneSelect">é€‰æ‹©æœºå‹:</label>
                    <select id="slidingIphoneSelect">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="totalDaysInput">æ€»åˆ†ææ—¶é•¿ (å¤©):</label>
                    <input type="number" id="totalDaysInput" value="30" min="1" max="90"
                           style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="windowSizeInput">çª—å£å¤§å° (å¤©):</label>
                    <input type="number" id="windowSizeInput" value="3" min="1" max="30"
                           style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label for="stepSizeInput">æ­¥é•¿ (å°æ—¶):</label>
                    <input type="number" id="stepSizeInput" value="6" min="1" max="24"
                           style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;">
                </div>
            </div>

            <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05));
                        border: 2px solid var(--primary-color); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                <p id="slidingWindowEstimate" style="margin: 0; font-size: 14px; color: var(--text-primary);">
                    <strong>é¢„è®¡åˆ›å»ºä»»åŠ¡æ•°:</strong> è¯·å¡«å†™å‚æ•°
                </p>
            </div>

            <div class="button-group">
                <button class="task-button" onclick="startSlidingWindowAnalysis()"
                        style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                    ğŸŒŠ å¼€å§‹æ»‘åŠ¨çª—å£åˆ†æ
                </button>
            </div>
        </div>

        <!-- Historical Results Selector -->
        <div id="historySection" class="controls" style="display: none;">
            <h2>ğŸ“œ Historical Results</h2>
            <div class="form-group">
                <label for="historySelect">é€‰æ‹©å†å²åˆ†æç»“æœ:</label>
                <select id="historySelect" onchange="loadSelectedResult()">
                    <option value="">-- è¯·é€‰æ‹© --</option>
                </select>
            </div>
        </div>

        <!-- Results Display Section -->
        <div id="resultsSection" class="results-section">
            <h2>ğŸ“ˆ Analysis Results</h2>

            <!-- Summary Cards -->
            <div class="summary-grid" id="summaryGrid">
                <!-- Cards will be populated by JavaScript -->
            </div>

            <!-- Interpretation Guide -->
            <div class="interpretation-box">
                <h3>ğŸ“– ç»“æœè§£è¯»æ–¹æ³•</h3>
                <ul>
                    <li><strong>é¢†å¤´åº— (Leader Shops):</strong> è¿™äº›åº—é“ºçš„ä»·æ ¼å˜åŠ¨å¯¹å…¶ä»–åº—é“ºäº§ç”Ÿæœ€å¤§å½±å“ã€‚å½±å“åŠ›è®¡ç®—ä¸ºï¼šå‡ºåº¦æ•°é‡ Ã— å¹³å‡å› æœæƒé‡ã€‚</li>
                    <li><strong>å› æœé‚»æ¥çŸ©é˜µ (Causal Adjacency Matrix):</strong> çŸ©é˜µä¸­ A[i][j] è¡¨ç¤ºåº—é“º j å¯¹åº—é“º i çš„å› æœå½±å“å¼ºåº¦ã€‚é¢œè‰²è¶Šæ·±è¡¨ç¤ºå½±å“è¶Šå¼ºã€‚</li>
                    <li><strong>Granger æ˜¾è‘—æ€§:</strong> p-value < 0.05 è¡¨ç¤ºå› æœå…³ç³»åœ¨ç»Ÿè®¡ä¸Šæ˜¾è‘—ï¼Œå³åº—é“º j çš„å†å²ä»·æ ¼å˜åŒ–èƒ½å¤Ÿé¢„æµ‹åº—é“º i çš„ä»·æ ¼å˜åŒ–ã€‚</li>
                    <li><strong>VAR æ¨¡å‹:</strong> å‘é‡è‡ªå›å½’æ¨¡å‹ï¼Œæ»åé˜¶æ•° (lag_order) è¡¨ç¤ºä½¿ç”¨è¿‡å»å¤šå°‘ä¸ªæ—¶é—´ç‚¹çš„æ•°æ®æ¥é¢„æµ‹å½“å‰ä»·æ ¼ã€‚AIC è¶Šå°è¡¨ç¤ºæ¨¡å‹æ‹Ÿåˆè¶Šå¥½ã€‚</li>
                </ul>
            </div>

            <!-- Leader Shops Table -->
            <h3>ğŸ† é¢†å¤´åº—æ’å (Leader Shops Ranking)</h3>
            <table id="leaderShopsTable">
                <thead>
                    <tr>
                        <th>æ’å</th>
                        <th>åº—é“ºåç§°</th>
                        <th>å½±å“åŠ›å¾—åˆ†</th>
                        <th>å‡ºåº¦æ•°é‡</th>
                        <th>å¹³å‡æƒé‡</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be populated by JavaScript -->
                </tbody>
            </table>

            <!-- Causal Adjacency Matrix Heatmap -->
            <h3>ğŸ”¥ å› æœé‚»æ¥çŸ©é˜µçƒ­åŠ›å›¾ (Causal Adjacency Matrix)</h3>
            <p style="margin-bottom: 16px; color: var(--text-secondary);">
                æ¨ªè½´: å½±å“æºåº—é“º (Source Shop) | çºµè½´: è¢«å½±å“åº—é“º (Target Shop) | é¢œè‰²å¼ºåº¦: å› æœå½±å“æƒé‡
            </p>
            <div class="chart-container">
                <canvas id="heatmapChart"></canvas>
            </div>

            <!-- Significant Causal Edges Table -->
            <h3>ğŸ”— æ˜¾è‘—å› æœå…³ç³» (Significant Causal Edges)</h3>
            <table id="causalEdgesTable">
                <thead>
                    <tr>
                        <th>æºåº—é“º (Source)</th>
                        <th>ç›®æ ‡åº—é“º (Target)</th>
                        <th>æ»åé˜¶æ•° (Lag)</th>
                        <th>æƒé‡ (Weight)</th>
                        <th>P-value</th>
                        <th>æ˜¾è‘—æ€§</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Mathematical Model Description (Collapsible) -->
        <div class="math-section">
            <details>
                <summary>ğŸ“ æ•°å­¦æ¨¡å‹è¯¦è§£ (Mathematical Model Documentation)</summary>
                <div class="math-content">
                    <h2>å¤šåº—é“º Ã— å¤šæœºç§ Ã— æ—¶é—´çš„å› æœåˆ†ææ¡†æ¶</h2>

                    <p>æœ¬ç³»ç»Ÿé‡‡ç”¨ç»Ÿä¸€çš„æ•°å­¦ç¬¦å·ä½“ç³»æ¥æè¿°"å¤šåº—é“º Ã— å¤šæœºç§ Ã— æ—¶é—´"çš„ä»·æ ¼åŠ¨æ€ï¼Œæ”¯æŒå› æœåˆ†æã€VARå»ºæ¨¡å’Œç‰¹å¾å·¥ç¨‹ã€‚</p>

                    <h3>1. ç´¢å¼•ä¸é›†åˆ</h3>

                    <h4>åº—é“ºé›†åˆ</h4>
                    <div class="formula-block">
                        $$\mathcal{S} = \{1,2,\dots,S\}, \quad s \in \mathcal{S}$$
                    </div>
                    <p>ä¾‹å¦‚ï¼šæµ·å³¡é€šä¿¡ã€ã‚¢ã‚­ãƒ¢ãƒã€è²·å–ä¸€ä¸ç›®ã€æ£®æ£®è²·å– ç­‰ã€‚</p>

                    <h4>æœºç§/å‹å·é›†åˆï¼ˆç²¾ç»†åˆ°å‹å·Ã—å®¹é‡Ã—é¢œè‰²çš„SKUï¼‰</h4>
                    <div class="formula-block">
                        $$\mathcal{P} = \{1,2,\dots,P\}, \quad p \in \mathcal{P}$$
                    </div>
                    <p>å¯¹åº”æ•°æ®åº“é‡Œçš„ Iphone / part_number æˆ– "model Ã— capacity Ã— color" å”¯ä¸€ç»„åˆã€‚</p>

                    <h4>ç¦»æ•£æ—¶é—´ï¼ˆåˆ†é’Ÿçº§bucketï¼‰</h4>
                    <div class="formula-block">
                        $$\mathcal{T} = \{\dots, t-1, t, t+1, \dots\}, \quad t \in \mathbb{Z}$$
                    </div>
                    <p>ç­‰é—´éš”æ—¶é—´ç‚¹ï¼ˆæ¯1åˆ†é’Ÿã€æ¯15åˆ†é’Ÿï¼‰ï¼Œç³»ç»Ÿä¸­ä¸ºJSTå¯¹é½åçš„ bucket_start_tsã€‚</p>

                    <h3>2. åŸå§‹è§‚æµ‹æ•°æ®ï¼šå¤šç»´å¼ é‡è¡¨ç¤º</h3>

                    <p>å¯¹æ¯ä¸€ä¸ªã€Œåº—é“º \(s\) Ã— æœºç§ \(p\) Ã— æ—¶é—´ \(t\)ã€ï¼Œè§‚æµ‹åˆ°å¤šä¸ªå˜é‡ï¼š</p>

                    <h4>ä»·æ ¼ï¼ˆå›æ”¶ä»·ï¼‰</h4>
                    <div class="formula-block">
                        $$P_{s,p,t} \in \mathbb{R}_{+}$$
                    </div>

                    <h4>å¯ç”¨åº“å­˜æ•°é‡ï¼ˆå¯é€‰ï¼‰</h4>
                    <div class="formula-block">
                        $$Q_{s,p,t} \in \mathbb{N}_0$$
                    </div>

                    <h4>å…¶ä»–å±æ€§ç‰¹å¾å‘é‡</h4>
                    <div class="formula-block">
                        $$\mathbf{F}_{s,p,t} \in \mathbb{R}^{K}$$
                    </div>

                    <p>æ•´ä½“ä¸Šæœ‰ä¸€ä¸ªä¸‰ç»´ï¼ˆç”šè‡³å››ç»´ï¼‰å¼ é‡ï¼š</p>
                    <div class="formula-block">
                        $$\mathbf{X}_t = \left\{ X_{s,p,t} \right\}_{s \in \mathcal{S},\, p \in \mathcal{P}}$$
                    </div>

                    <p>å…¶ä¸­æ¯ä¸ªå…ƒç´  \(X_{s,p,t}\) æ˜¯ä¸€ä¸ªç‰¹å¾å‘é‡ï¼š</p>
                    <div class="formula-block">
                        $$X_{s,p,t} = \big(P_{s,p,t}, Q_{s,p,t}, \mathbf{F}_{s,p,t}\big) \in \mathbb{R}^{1+1+K}$$
                    </div>

                    <div class="highlight-box">
                        <h4>ğŸ’¡ ç›´è§‚ç†è§£</h4>
                        <p>æ¯ä¸ªæ—¶é—´ \(t\)ï¼Œæœ‰ä¸€ä¸ª "åº— Ã— æœºç§" çš„å¤§è¡¨æ ¼ï¼Œæ ¼å­é‡Œæ”¾çš„æ˜¯è¿™ä¸ªåº—å¯¹è¿™ä¸ªæœºç§çš„å„ç§æ•°å€¼ç‰¹å¾ã€‚</p>
                    </div>

                    <h3>3. æ•°æ®æ¸…æ´—ä¸å¯¹é½ï¼ˆå¯¹åº”PSTAæ¨¡å‹ï¼‰</h3>

                    <h4>3.1 æ¸…æ´—ï¼ˆå»å¼‚å¸¸ï¼‰</h4>
                    <p>å®šä¹‰æ¸…æ´—ç®—å­ \(C(\cdot)\)ï¼š</p>
                    <div class="formula-block">
                        $$\tilde{P}_{s,p,t} = C\big(P_{s,p,t}\big)$$
                    </div>
                    <ul>
                        <li>è‹¥ \(P_{s,p,t} < 10000\) æˆ– \(P_{s,p,t} > 350000\) åˆ™æ ‡è®°ä¸ºç¼ºå¤±æˆ–ä¸¢å¼ƒ</li>
                        <li>å¦åˆ™ä¿ç•™åŸå€¼</li>
                    </ul>

                    <h4>3.2 æ—¶é—´å¯¹é½ï¼ˆbucketåŒ–ï¼‰</h4>
                    <p>PSTAå¯¹åŒä¸€æ—¶é—´bucketå†…çš„è®°å½•åšèšåˆï¼š</p>
                    <div class="formula-block">
                        $$\bar{P}_{s,p,t} = \operatorname{Agg}\big(\{\tilde{P}_{s,p,\tau}\ |\ \tau \in \text{bucket}(t)\}\big)$$
                    </div>
                    <p>å…¶ä¸­ï¼š</p>
                    <ul>
                        <li>\(\text{bucket}(t)\) æ˜¯è½åœ¨è¯¥æ—¶é—´æ¡¶å†…çš„åŸå§‹æ—¶é—´ç‚¹é›†åˆ</li>
                        <li>\(\operatorname{Agg}(\cdot)\) å¯ä»¥æ˜¯å¹³å‡å€¼ã€åŠ æƒå¹³å‡ã€ä¸­ä½æ•°ç­‰</li>
                    </ul>

                    <p>å¾—åˆ°å¯¹é½åï¼ˆæ—¶é—´æ¡¶çº§ï¼‰çš„ä¸»ä»·æ ¼åºåˆ—ï¼š</p>
                    <div class="formula-block">
                        $$\bar{P}_{s,p,t}, \quad t \in \mathcal{T}$$
                    </div>

                    <h3>4. å¹³ç¨³åŒ–ä¸æ ‡å‡†åŒ–ï¼šä»·æ ¼å˜åŒ–è¿‡ç¨‹</h3>

                    <h4>4.1 å¯¹æ•°ä¸å·®åˆ†</h4>
                    <p>ä¸ºå¤„ç†æ¯”ä¾‹å˜åŒ–ã€æ¶ˆé™¤è¶‹åŠ¿ï¼Œå…ˆå–å¯¹æ•°ï¼š</p>
                    <div class="formula-block">
                        $$Y_{s,p,t} = \log \bar{P}_{s,p,t}$$
                    </div>

                    <p>ç„¶ååœ¨æ—¶é—´ä¸Šåšä¸€é˜¶å·®åˆ†å¾—åˆ°"æ¶¨è·Œå¹…"ï¼š</p>
                    <div class="formula-block">
                        $$\Delta Y_{s,p,t} = Y_{s,p,t} - Y_{s,p,t-1}$$
                    </div>
                    <p>è¿™æ˜¯ä¸€ä¸ªå¹³ç¨³æ—¶é—´åºåˆ—è¿‘ä¼¼ï¼Œä»£è¡¨åœ¨ \(t\) æ—¶åˆ»ç›¸å¯¹äº \(t-1\) çš„ä»·æ ¼å˜åŒ–ï¼ˆä»¥logå½¢å¼ï¼‰ã€‚</p>

                    <h4>4.2 Z-scoreæ ‡å‡†åŒ–ï¼ˆè·¨åº—ã€è·¨æœºç§å¯æ¯”ï¼‰</h4>
                    <p>ä¸ºäº†è®©ä¸åŒåº—ã€ä¸åŒæœºç§çš„åºåˆ—åœ¨åŒä¸€æ•°å€¼å°ºåº¦ä¸Šè¿›è¡Œå› æœå’ŒVARåˆ†æï¼Œå¯¹ \(\Delta Y_{s,p,t}\) åšæ ‡å‡†åŒ–ã€‚</p>

                    <p>å®šä¹‰åœ¨æ—¶é—´çª—å£ \(\mathcal{T}_0\) ä¸Šçš„å‡å€¼å’Œæ ‡å‡†å·®ï¼š</p>
                    <div class="formula-block">
                        $$\mu_{s,p} = \mathbb{E}_{t \in \mathcal{T}_0}[\Delta Y_{s,p,t}], \qquad
\sigma_{s,p} = \operatorname{Std}_{t \in \mathcal{T}_0}[\Delta Y_{s,p,t}]$$
                    </div>

                    <p>ç„¶åè®¡ç®—æ ‡å‡†åŒ–å˜é‡ï¼š</p>
                    <div class="formula-block">
                        $$Z_{s,p,t} = \frac{\Delta Y_{s,p,t} - \mu_{s,p}}{\sigma_{s,p}}$$
                    </div>

                    <div class="highlight-box">
                        <h4>ğŸ¯ å…³é”®å˜é‡</h4>
                        <p>\(Z_{s,p,t}\) æ˜¯è¿›è¡Œå› æœåˆ†æã€å»ºVARæ¨¡å‹ã€å­¦ä¹ å›¾ç»“æ„æ—¶çš„<strong>ä¸»å·¥ä½œå˜é‡</strong>ã€‚</p>
                    </div>

                    <h3>5. æŒ‰æœºç§èšåˆï¼šè·¨åº—çš„å‘é‡æ—¶é—´åºåˆ—</h3>

                    <p>å¯¹æ¯ä¸€ä¸ªæœºç§ \(p \in \mathcal{P}\)ï¼Œæ•´ç†å‡ºä¸€ä¸ª"è·¨åº—å‘é‡"åºåˆ—ï¼š</p>
                    <div class="formula-block">
                        $$\mathbf{z}_{p,t} =
\begin{bmatrix}
Z_{1,p,t} \\
Z_{2,p,t} \\
\vdots \\
Z_{S,p,t}
\end{bmatrix}
\in \mathbb{R}^{S}, \quad t \in \mathcal{T}$$
                    </div>

                    <p>è¿™è¡¨ç¤ºï¼šåœ¨æ—¶é—´ \(t\) æ—¶åˆ»ï¼Œå¯¹æœºç§ \(p\) æ¥è¯´ï¼Œæ‰€æœ‰åº—é“ºåœ¨è¿™ä¸€åˆ»çš„"æ ‡å‡†åŒ–ä»·æ ¼å˜åŒ–"ç»„æˆä¸€ä¸ª \(S\) ç»´å‘é‡ã€‚</p>

                    <p>äºæ˜¯å¯¹äºæ¯ä¸€ä¸ªæœºç§ \(p\)ï¼Œæœ‰ä¸€ä¸ªå¤šå˜é‡æ—¶é—´åºåˆ—ï¼š</p>
                    <div class="formula-block">
                        $$\{\mathbf{z}_{p,t}\}_{t \in \mathcal{T}}$$
                    </div>

                    <p>è¿™å°†ç›´æ¥ä½œä¸ºï¼š</p>
                    <ul>
                        <li>VAR / SVAR æ¨¡å‹çš„è¾“å…¥</li>
                        <li>Granger å› æœæµ‹è¯•çš„è¾“å…¥</li>
                        <li>åŠ¨æ€å› æœå›¾ï¼ˆDAGï¼‰çš„å­¦ä¹ è¾“å…¥</li>
                    </ul>

                    <h3>6. ç»“æ„æ¨¡å‹ï¼ˆä»¥VARä¸ºä¾‹ï¼‰</h3>

                    <p>å¯¹å›ºå®šæœºç§ \(p\)ï¼Œä¸€ä¸ªæ ‡å‡†çš„ VAR(\(L\)) æ¨¡å‹å¯ä»¥å†™æˆï¼š</p>
                    <div class="formula-block">
                        $$\mathbf{z}_{p,t}
=
A^{(p)}_1 \mathbf{z}_{p,t-1}
+ A^{(p)}_2 \mathbf{z}_{p,t-2}
+ \dots
+ A^{(p)}_L \mathbf{z}_{p,t-L}
+ \boldsymbol{\varepsilon}_{p,t}$$
                    </div>

                    <p>å…¶ä¸­ï¼š</p>
                    <ul>
                        <li>\(\mathbf{z}_{p,t} \in \mathbb{R}^S\)ï¼šæœºç§ \(p\) åœ¨æ—¶é—´ \(t\) çš„è·¨åº—ä»·æ ¼å˜åŒ–å‘é‡</li>
                        <li>\(A^{(p)}_\ell \in \mathbb{R}^{S \times S}\)ï¼šæ»å \(\ell\) å¯¹åº”çš„å½±å“çŸ©é˜µ</li>
                        <li>\(\boldsymbol{\varepsilon}_{p,t} \sim \mathcal{N}(0, \Sigma_p)\)ï¼šå™ªå£°é¡¹</li>
                    </ul>

                    <div class="highlight-box">
                        <h4>ğŸ“Š è§£é‡Š</h4>
                        <ul>
                            <li>\(A^{(p)}_\ell(i,j)\) è¡¨ç¤ºï¼šåœ¨æœºç§ \(p\) ä¸Šï¼Œåº— \(j\) åœ¨æ—¶é—´ \(t-\ell\) çš„ä»·æ ¼å˜åŒ–ï¼Œå¯¹åº— \(i\) åœ¨æ—¶é—´ \(t\) çš„ä»·æ ¼å˜åŒ–çš„çº¿æ€§å½±å“å¼ºåº¦</li>
                            <li>è‹¥ \(A^{(p)}_\ell(i,j)\) åœ¨ç»Ÿè®¡ä¸Šæ˜¾è‘—éé›¶ï¼Œå¯ä»¥è§£é‡Šä¸º"åº— \(j\) çš„å˜åŒ–ï¼ˆåœ¨æ»å \(\ell\)ï¼‰Grangerå› æœåœ°å½±å“åº— \(i\)"</li>
                        </ul>
                    </div>

                    <p>å¯ä»¥å¯¹æ¯ä¸ªæœºç§ \(p\) ä¼°è®¡ä¸€æ•´å¥—çŸ©é˜µ \(A^{(p)}_{1..L}\)ï¼Œä¹Ÿå¯ä»¥æŠŠå¤šæœºç§æ‹¼æˆæ›´å¤§çš„å—ç»“æ„æ¨¡å‹ã€‚</p>

                    <h3>7. å› æœå›¾è¡¨ç¤ºï¼ˆè·¨åº—ã€è·¨æœºç§ï¼‰</h3>

                    <p>å¯ä»¥æŠŠä¸Šé¢çš„VARå‚æ•°æˆ–Grangerç»“æœè½¬åŒ–ä¸ºä¸€ä¸ªæœ‰å‘å›¾ï¼š</p>

                    <h4>å›¾çš„èŠ‚ç‚¹</h4>
                    <p>å¯ä»¥æ˜¯ã€Œåº—é“ºç»´åº¦ã€æˆ–ã€Œåº—é“º Ã— æœºç§ç»´åº¦ã€ï¼š</p>
                    <div class="formula-block">
                        $$\mathcal{V} = \{(s,p)\ |\ s \in \mathcal{S}, p \in \mathcal{P}\}$$
                    </div>

                    <h4>æœ‰å‘è¾¹</h4>
                    <div class="formula-block">
                        $$(s',p) \to (s,p)$$
                    </div>
                    <p>è‹¥å­˜åœ¨æŸä¸ªæ»å \(\ell\)ï¼Œä½¿å¾—åœ¨æœºç§ \(p\) ä¸Šçš„VARä¸­ \(A^{(p)}_\ell(s, s')\) æ˜¾è‘—éé›¶ã€‚</p>

                    <p>è¿™æ ·å¯ä»¥æ„é€ å‡ºä¸€ä¸ª<strong>"å¸‚åœºå› æœç½‘ç»œ"</strong>ï¼š</p>
                    <ul>
                        <li>å“ªäº›åº—æ˜¯ <strong>price leader</strong>ï¼ˆå‡ºåº¦å¤§ã€å½±å“å¼ºï¼‰</li>
                        <li>å“ªäº›åº—æ˜¯ <strong>follower</strong>ï¼ˆå…¥åº¦å¤§ï¼‰</li>
                        <li>ä¸åŒæœºç§ \(p\) ä¸Šçš„ç»“æ„æ˜¯å¦ä¸åŒ</li>
                    </ul>

                    <h3>8. æ€»ç»“</h3>

                    <div class="highlight-box">
                        <h4>ğŸ¯ æ ¸å¿ƒæ¦‚è¿°</h4>
                        <p>æœ¬ç³»ç»Ÿå¤„ç†ä¸€ä¸ªä¸‰ç»´æ—¶é—´åºåˆ—ï¼š</p>
                        <div class="formula-block">
                            $$\big\{X_{s,p,t}\big\}_{s \in \mathcal{S},\, p \in \mathcal{P},\, t \in \mathcal{T}}$$
                        </div>
                        <p>å…¶ä¸­ \(X_{s,p,t}\) ä¸»è¦åŒ…å«ä»·æ ¼ \(P_{s,p,t}\) ç­‰ç‰¹å¾ã€‚</p>

                        <p><strong>å¤„ç†æµç¨‹ï¼š</strong></p>
                        <ol>
                            <li>æ¸…æ´—ã€æ—¶é—´å¯¹é½ã€å·®åˆ†ä¸æ ‡å‡†åŒ– â†’ å¾—åˆ°å¹³ç¨³çš„ä»·æ ¼å˜åŒ–è¿‡ç¨‹ \(Z_{s,p,t}\)</li>
                            <li>æŒ‰æœºç§ \(p\) ç»„ç»‡æˆè·¨åº—å‘é‡æ—¶é—´åºåˆ— \(\mathbf{z}_{p,t}\)</li>
                            <li>æ„å»º VAR / å› æœæ¨¡å‹</li>
                            <li>å­¦ä¹ å’Œåˆ†æåº—é“ºä¹‹é—´éšæ—¶é—´æ¼”åŒ–çš„å› æœç»“æ„ä¸ä»·æ ¼ä¼ å¯¼å…³ç³»</li>
                        </ol>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <script>
        // API endpoints
        const API = {
            iphones: '/AppleStockChecker/automl/iphones/',
            createJob: '/AppleStockChecker/automl/jobs/create/',
            batchCreate: '/AppleStockChecker/automl/jobs/batch-create/',
            completedJobs: '/AppleStockChecker/automl/jobs/completed/',
            jobResult: (id) => `/AppleStockChecker/automl/jobs/result/${id}/`,
            slidingWindow: '/AppleStockChecker/automl/jobs/sliding-window/',
        };

        let currentHeatmapChart = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadIphones();
            loadIphonesForSlidingWindow();
            setupSlidingWindowEventListeners();
        });

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';

            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function loadIphones() {
            try {
                const response = await fetch(API.iphones);
                const data = await response.json();

                const select = document.getElementById('iphoneSelect');
                select.innerHTML = '<option value="">-- è¯·é€‰æ‹©æœºå‹ --</option>';

                if (data.status === 'success' && data.iphones.length > 0) {
                    data.iphones.forEach(iphone => {
                        const option = document.createElement('option');
                        option.value = iphone.id;

                        // æ„å»ºè¯¦ç»†çš„æ˜¾ç¤ºæ–‡æœ¬
                        let displayText = iphone.part_number;

                        if (iphone.model_name) {
                            displayText += ` - ${iphone.model_name}`;
                        }

                        if (iphone.capacity_gb) {
                            displayText += ` ${iphone.capacity_gb}GB`;
                        }

                        if (iphone.color) {
                            displayText += ` ${iphone.color}`;
                        }

                        option.textContent = displayText;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">æš‚æ— å¯ç”¨æœºå‹</option>';
                }
            } catch (error) {
                console.error('Error loading iPhones:', error);
                showStatus('åŠ è½½æœºå‹åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        async function analyzeSingle() {
            const iphoneId = document.getElementById('iphoneSelect').value;
            const days = document.getElementById('daysSelect').value;

            if (!iphoneId) {
                showStatus('è¯·å…ˆé€‰æ‹©æœºå‹', 'error');
                return;
            }

            try {
                showStatus(`æ­£åœ¨åˆ›å»ºåˆ†æä»»åŠ¡... (æœºå‹ ID: ${iphoneId}, çª—å£: ${days}å¤©)`, 'info');

                const response = await fetch(API.createJob, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        iphone_id: parseInt(iphoneId),
                        days: parseInt(days)
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(`åˆ†æä»»åŠ¡å·²åˆ›å»ºæˆåŠŸ! Job ID: ${data.job_id}`, 'success');
                } else {
                    showStatus(data.error || 'åˆ›å»ºä»»åŠ¡å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Error creating job:', error);
                showStatus(`é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function analyzeAll() {
            const days = document.getElementById('daysSelect').value;

            if (!confirm(`ç¡®å®šè¦æ‰¹é‡åˆ†ææ‰€æœ‰æœºå‹å—ï¼Ÿ(åˆ†æçª—å£: ${days}å¤©)`)) {
                return;
            }

            try {
                showStatus(`æ­£åœ¨æ‰¹é‡åˆ›å»ºåˆ†æä»»åŠ¡... (çª—å£: ${days}å¤©)`, 'info');

                const response = await fetch(API.batchCreate, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        days: parseInt(days)
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(`æ‰¹é‡ä»»åŠ¡å·²åˆ›å»º! å…± ${data.jobs_created.length} ä¸ªä»»åŠ¡`, 'success');
                } else {
                    showStatus(data.error || 'æ‰¹é‡åˆ›å»ºä»»åŠ¡å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Error batch creating jobs:', error);
                showStatus(`é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function viewResults() {
            try {
                showStatus('æ­£åœ¨åŠ è½½å†å²ç»“æœ...', 'info');

                const response = await fetch(API.completedJobs);
                const data = await response.json();

                if (response.ok) {
                    const historySelect = document.getElementById('historySelect');
                    historySelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';

                    if (data.status === 'success' && data.count > 0 && data.jobs_by_iphone) {
                        data.jobs_by_iphone.forEach(group => {
                            const optgroup = document.createElement('optgroup');

                            // æ„å»ºè¯¦ç»†çš„æœºå‹æ˜¾ç¤ºæ–‡æœ¬
                            let iphoneLabel = group.part_number;
                            if (group.model_name) {
                                iphoneLabel += ` - ${group.model_name}`;
                            }
                            if (group.capacity_gb) {
                                iphoneLabel += ` ${group.capacity_gb}GB`;
                            }
                            if (group.color) {
                                iphoneLabel += ` ${group.color}`;
                            }
                            iphoneLabel += ` (${group.jobs.length} æ¡è®°å½•)`;

                            optgroup.label = iphoneLabel;

                            group.jobs.forEach(job => {
                                const option = document.createElement('option');
                                option.value = job.job_id;
                                // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                                const date = new Date(job.created_at);
                                const dateStr = date.toLocaleString('zh-CN');
                                option.textContent = `${dateStr}`;
                                optgroup.appendChild(option);
                            });

                            historySelect.appendChild(optgroup);
                        });

                        document.getElementById('historySection').style.display = 'block';
                        showStatus(`æ‰¾åˆ° ${data.count} ä¸ªæœºå‹çš„å†å²è®°å½•`, 'success');
                    } else {
                        showStatus('æš‚æ— å†å²è®°å½•', 'info');
                    }
                } else {
                    showStatus(data.error || 'åŠ è½½å†å²è®°å½•å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Error loading results:', error);
                showStatus(`é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function loadSelectedResult() {
            const jobId = document.getElementById('historySelect').value;

            if (!jobId) {
                return;
            }

            try {
                showStatus(`æ­£åœ¨åŠ è½½ Job #${jobId} çš„åˆ†æç»“æœ...`, 'info');

                const response = await fetch(API.jobResult(jobId));
                const data = await response.json();

                if (response.ok) {
                    displayResult(data);
                    showStatus('ç»“æœåŠ è½½æˆåŠŸ', 'success');
                } else {
                    showStatus(data.error || 'åŠ è½½ç»“æœå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Error loading job result:', error);
                showStatus(`é”™è¯¯: ${error.message}`, 'error');
            }
        }

        function displayResult(data) {
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.add('visible');

            // Display summary cards
            const summaryGrid = document.getElementById('summaryGrid');
            const shopCount = data.var_model?.shop_ids?.length || 'N/A';
            summaryGrid.innerHTML = `
                <div class="summary-card">
                    <h3>åˆ†æåº—é“ºæ•°</h3>
                    <p>${shopCount}</p>
                </div>
                <div class="summary-card">
                    <h3>VAR æ»åé˜¶æ•°</h3>
                    <p>${data.var_model?.lag_order || 'N/A'}</p>
                </div>
                <div class="summary-card">
                    <h3>å› æœè¾¹æ•°é‡</h3>
                    <p>${data.causal_edges?.length || 0}</p>
                </div>
                <div class="summary-card">
                    <h3>æ¨¡å‹ AIC</h3>
                    <p>${data.var_model?.aic ? data.var_model.aic.toFixed(2) : 'N/A'}</p>
                </div>
            `;

            // Display leader shops
            if (data.leader_shops && data.leader_shops.length > 0) {
                displayLeaderShops(data.leader_shops);
            }

            // Display heatmap
            if (data.adjacency_matrix) {
                displayHeatmap(data.adjacency_matrix);
            }

            // Display causal edges
            if (data.causal_edges && data.causal_edges.length > 0) {
                displayCausalEdges(data.causal_edges);
            }

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function displayLeaderShops(leaderShops) {
            const tbody = document.querySelector('#leaderShopsTable tbody');
            tbody.innerHTML = '';

            leaderShops.forEach((shop, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>#${index + 1}</strong></td>
                    <td>${shop.shop_name}</td>
                    <td><strong>${shop.influence.toFixed(4)}</strong></td>
                    <td>${shop.outgoing_count}</td>
                    <td>${shop.avg_weight.toFixed(4)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayHeatmap(adjacencyMatrix) {
            const ctx = document.getElementById('heatmapChart').getContext('2d');

            // Destroy previous chart if exists
            if (currentHeatmapChart) {
                currentHeatmapChart.destroy();
            }

            // Prepare data for Chart.js matrix
            const matrixData = [];
            const shopNames = adjacencyMatrix.shop_names;

            for (let i = 0; i < adjacencyMatrix.matrix.length; i++) {
                for (let j = 0; j < adjacencyMatrix.matrix[i].length; j++) {
                    matrixData.push({
                        x: shopNames[j],
                        y: shopNames[i],
                        v: adjacencyMatrix.matrix[i][j]
                    });
                }
            }

            currentHeatmapChart = new Chart(ctx, {
                type: 'matrix',
                data: {
                    datasets: [{
                        label: 'Causal Influence',
                        data: matrixData,
                        backgroundColor(context) {
                            const value = context.dataset.data[context.dataIndex].v;
                            const alpha = Math.abs(value);
                            return value > 0
                                ? `rgba(59, 130, 246, ${alpha})`
                                : `rgba(239, 68, 68, ${Math.min(alpha, 0.8)})`;
                        },
                        borderWidth: 1,
                        borderColor: 'rgba(0, 0, 0, 0.1)',
                        width: ({chart}) => (chart.chartArea || {}).width / shopNames.length - 1,
                        height: ({chart}) => (chart.chartArea || {}).height / shopNames.length - 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title() {
                                    return '';
                                },
                                label(context) {
                                    const v = context.dataset.data[context.dataIndex];
                                    return [
                                        `Source: ${v.x}`,
                                        `Target: ${v.y}`,
                                        `Weight: ${v.v.toFixed(4)}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            labels: shopNames,
                            ticks: {
                                display: true,
                                autoSkip: false,
                                maxRotation: 90,
                                minRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            type: 'category',
                            labels: shopNames,
                            offset: true,
                            ticks: {
                                display: true
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function displayCausalEdges(causalEdges) {
            const tbody = document.querySelector('#causalEdgesTable tbody');
            tbody.innerHTML = '';

            causalEdges.forEach(edge => {
                const row = document.createElement('tr');
                const significanceBadge = edge.min_pvalue < 0.05
                    ? '<span class="badge high">æ˜¾è‘— âœ“</span>'
                    : '<span class="badge low">ä¸æ˜¾è‘—</span>';

                row.innerHTML = `
                    <td>${edge.cause_shop_name}</td>
                    <td>${edge.effect_shop_name}</td>
                    <td>${edge.main_lag}</td>
                    <td>${edge.weight.toFixed(4)}</td>
                    <td>${edge.min_pvalue.toFixed(4)}</td>
                    <td>${significanceBadge}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // === Sliding Window Analysis Functions ===

        async function loadIphonesForSlidingWindow() {
            try {
                const response = await fetch(API.iphones);
                const data = await response.json();

                const select = document.getElementById('slidingIphoneSelect');
                select.innerHTML = '<option value="">-- è¯·é€‰æ‹©æœºå‹ --</option>';

                if (data.status === 'success' && data.iphones.length > 0) {
                    data.iphones.forEach(iphone => {
                        const option = document.createElement('option');
                        option.value = iphone.id;

                        // æ„å»ºè¯¦ç»†çš„æ˜¾ç¤ºæ–‡æœ¬
                        let displayText = iphone.part_number;

                        if (iphone.model_name) {
                            displayText += ` - ${iphone.model_name}`;
                        }

                        if (iphone.capacity_gb) {
                            displayText += ` ${iphone.capacity_gb}GB`;
                        }

                        if (iphone.color) {
                            displayText += ` ${iphone.color}`;
                        }

                        option.textContent = displayText;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">æš‚æ— å¯ç”¨æœºå‹</option>';
                }
            } catch (error) {
                console.error('Error loading iPhones for sliding window:', error);
                showStatus('åŠ è½½æœºå‹åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        function setupSlidingWindowEventListeners() {
            const totalDaysInput = document.getElementById('totalDaysInput');
            const windowSizeInput = document.getElementById('windowSizeInput');
            const stepSizeInput = document.getElementById('stepSizeInput');

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œå½“å‚æ•°æ”¹å˜æ—¶æ›´æ–°ä¼°è®¡
            [totalDaysInput, windowSizeInput, stepSizeInput].forEach(input => {
                input.addEventListener('input', updateSlidingWindowEstimate);
            });

            // åˆå§‹åŒ–ä¼°è®¡æ˜¾ç¤º
            updateSlidingWindowEstimate();
        }

        function updateSlidingWindowEstimate() {
            const totalDays = parseFloat(document.getElementById('totalDaysInput').value) || 0;
            const windowSize = parseFloat(document.getElementById('windowSizeInput').value) || 0;
            const stepSize = parseFloat(document.getElementById('stepSizeInput').value) || 0;

            const estimateEl = document.getElementById('slidingWindowEstimate');

            if (totalDays <= 0 || windowSize <= 0 || stepSize <= 0) {
                estimateEl.innerHTML = '<strong>é¢„è®¡åˆ›å»ºä»»åŠ¡æ•°:</strong> è¯·å¡«å†™å‚æ•°';
                return;
            }

            if (windowSize > totalDays) {
                estimateEl.innerHTML = '<strong>é¢„è®¡åˆ›å»ºä»»åŠ¡æ•°:</strong> <span style="color: red;">çª—å£å¤§å°ä¸èƒ½å¤§äºæ€»æ—¶é•¿</span>';
                return;
            }

            // è®¡ç®—æ»‘åŠ¨çª—å£æ•°é‡: floor((total_days - window_size) * 24 / step_size) + 1
            const numWindows = Math.floor((totalDays - windowSize) * 24 / stepSize) + 1;

            estimateEl.innerHTML = `<strong>é¢„è®¡åˆ›å»ºä»»åŠ¡æ•°:</strong> <span style="color: #2196F3; font-size: 1.2em; font-weight: bold;">${numWindows}</span> ä¸ªçª—å£`;
        }

        async function startSlidingWindowAnalysis() {
            const iphoneId = document.getElementById('slidingIphoneSelect').value;
            const totalDays = parseInt(document.getElementById('totalDaysInput').value);
            const windowSize = parseInt(document.getElementById('windowSizeInput').value);
            const stepSize = parseInt(document.getElementById('stepSizeInput').value);

            // éªŒè¯è¾“å…¥
            if (!iphoneId) {
                showStatus('è¯·å…ˆé€‰æ‹©æœºå‹', 'error');
                return;
            }

            if (totalDays <= 0 || windowSize <= 0 || stepSize <= 0) {
                showStatus('è¯·å¡«å†™æœ‰æ•ˆçš„å‚æ•°', 'error');
                return;
            }

            if (windowSize > totalDays) {
                showStatus('çª—å£å¤§å°ä¸èƒ½å¤§äºæ€»æ—¶é•¿', 'error');
                return;
            }

            try {
                showStatus('æ­£åœ¨åˆ›å»ºæ»‘åŠ¨çª—å£åˆ†æä»»åŠ¡...', 'info');

                const response = await fetch(API.slidingWindow, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        iphone_id: iphoneId,
                        total_days: totalDays,
                        window_size_days: windowSize,
                        step_size_hours: stepSize
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    const message = `âœ… æ»‘åŠ¨çª—å£åˆ†æä»»åŠ¡åˆ›å»ºæˆåŠŸï¼\n` +
                                    `â€¢ æ–°å»ºä»»åŠ¡: ${data.created_count}\n` +
                                    `â€¢ å·²å­˜åœ¨ä»»åŠ¡: ${data.existing_count}\n` +
                                    `â€¢ è·³è¿‡ä»»åŠ¡: ${data.skipped_count}\n` +
                                    `â€¢ æ€»çª—å£æ•°: ${data.total_windows}`;
                    showStatus(message, 'success');

                    // 5ç§’ååˆ·æ–°å†å²ç»“æœåˆ—è¡¨
                    setTimeout(() => {
                        loadHistoricalResults();
                    }, 5000);
                } else {
                    showStatus(`åˆ›å»ºå¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                console.error('Error creating sliding window analysis:', error);
                showStatus('åˆ›å»ºæ»‘åŠ¨çª—å£åˆ†æä»»åŠ¡å¤±è´¥', 'error');
            }
        }
    </script>
</body>
</html>
