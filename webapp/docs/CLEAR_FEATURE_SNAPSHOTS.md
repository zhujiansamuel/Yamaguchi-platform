# FeatureSnapshot æ¸…ç†è„šæœ¬ä½¿ç”¨æŒ‡å—

## ğŸ“‹ è„šæœ¬è¯´æ˜

`clear_feature_snapshots.py` ç”¨äºæ¸…é™¤ `FeatureSnapshot` è¡¨çš„æ‰€æœ‰æ•°æ®ã€‚

### é€‚ç”¨åœºæ™¯

- âœ… ç»Ÿè®¡æŒ‡æ ‡é‡æ„åæ¸…é™¤å†å²æ•°æ®
- âœ… æµ‹è¯•ç¯å¢ƒæ•°æ®é‡ç½®
- âœ… ä¿®å¤æ•°æ®é”™è¯¯åçš„å…¨é‡é‡ç®—
- âœ… é‡Šæ”¾æ•°æ®åº“å­˜å‚¨ç©ºé—´

### å®‰å…¨ç‰¹æ€§

- âœ… é»˜è®¤ Dry-run æ¨¡å¼ï¼ˆä»…æŸ¥çœ‹ç»Ÿè®¡ï¼‰
- âœ… æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡ä¿¡æ¯ï¼ˆè®°å½•æ•°ã€è¡¨å¤§å°ã€æ—¶é—´èŒƒå›´ç­‰ï¼‰
- âœ… äºŒæ¬¡ç¡®è®¤æœºåˆ¶ï¼ˆéœ€è¾“å…¥ `DELETE` ç¡®è®¤ï¼‰
- âœ… åˆ†æ‰¹åˆ é™¤é¿å…é•¿äº‹åŠ¡é”è¡¨
- âœ… è¿›åº¦æ˜¾ç¤ºå’Œæ€§èƒ½ç»Ÿè®¡

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³• 1: æœ¬åœ°ç›´æ¥è¿è¡Œï¼ˆæ¨èï¼‰

```bash
# 1. Dry-runï¼ˆä»…æŸ¥çœ‹ç»Ÿè®¡ï¼Œä¸åˆ é™¤ï¼‰
python scripts/clear_feature_snapshots.py

# 2. å®é™…åˆ é™¤ï¼ˆéœ€è¦äºŒæ¬¡ç¡®è®¤ï¼‰
python scripts/clear_feature_snapshots.py --execute

# 3. é™é»˜åˆ é™¤ï¼ˆè·³è¿‡ç¡®è®¤ï¼Œå±é™©ï¼ï¼‰
python scripts/clear_feature_snapshots.py --execute --force

# 4. è‡ªå®šä¹‰æ‰¹é‡å¤§å°
python scripts/clear_feature_snapshots.py --execute --batch-size 5000
```

### æ–¹æ³• 2: ä½¿ç”¨ Shell åŒ…è£…å™¨ï¼ˆè‡ªåŠ¨æ£€æµ‹ç¯å¢ƒï¼‰

```bash
# Shell åŒ…è£…å™¨ä¼šè‡ªåŠ¨æ£€æµ‹æ˜¯æœ¬åœ°ç¯å¢ƒè¿˜æ˜¯ Docker ç¯å¢ƒ
./scripts/clear_feature_snapshots.sh
./scripts/clear_feature_snapshots.sh --execute
./scripts/clear_feature_snapshots.sh --execute --force
```

### æ–¹æ³• 3: Docker ç¯å¢ƒ

```bash
# é€šè¿‡ Docker Compose è¿è¡Œ
docker compose exec web python scripts/clear_feature_snapshots.py
docker compose exec web python scripts/clear_feature_snapshots.py --execute

# æˆ–åœ¨å®¹å™¨å†…ç›´æ¥è¿è¡Œ
docker compose exec web bash
python scripts/clear_feature_snapshots.py
```

---

## ğŸ“Š è¾“å‡ºç¤ºä¾‹

### Dry-run æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰

```
======================================================================
 FeatureSnapshot æ¸…ç†è„šæœ¬
======================================================================
 æ—¶é—´: 2025-12-11 14:30:00+09:00
 æ¨¡å¼: ğŸŸ¢ è¯•è¿è¡Œæ¨¡å¼ (DRY-RUN)

======================================================================
 FeatureSnapshot è¡¨ç»Ÿè®¡ä¿¡æ¯
======================================================================

ğŸ“Š æ€»è®°å½•æ•°: 1,234,567
   è¡¨å¤§å°: 245 MB
   æ—¶é—´èŒƒå›´: 2025-10-01 00:00:00+09:00 ~ 2025-12-11 14:00:00+09:00

ğŸ“ˆ æ•°æ®æœ€ç»ˆåŒ–çŠ¶æ€:
   is_final=True:  800,000
   is_final=False: 434,567

ğŸ·ï¸  Top 10 ç‰¹å¾å (name):
   mean                     500,000 æ¡
   median                   500,000 æ¡
   std                      100,000 æ¡
   dispersion                80,000 æ¡
   count                     50,000 æ¡
   ...

ğŸ¯ Top 10 ä½œç”¨åŸŸå‰ç¼€ (scope):
   shop                     ~50,000 ä¸ª
   shopcohort               ~20,000 ä¸ª
   overall                  ~10,000 ä¸ª
   cohort                    ~5,000 ä¸ª

======================================================================

ğŸ’¡ æç¤ºï¼šè¿™æ˜¯ dry-run æ¨¡å¼ï¼Œæ•°æ®æœªè¢«åˆ é™¤
   å¦‚éœ€å®é™…åˆ é™¤ï¼Œè¯·ä½¿ç”¨: --execute
   åˆ é™¤å‰å»ºè®®å¤‡ä»½: ./scripts/pg_dump.sh
```

### Execute æ¨¡å¼

```
======================================================================
 FeatureSnapshot æ¸…ç†è„šæœ¬
======================================================================
 æ—¶é—´: 2025-12-11 14:30:00+09:00
 æ¨¡å¼: ğŸ”´ æ‰§è¡Œæ¨¡å¼ (EXECUTE)

[æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯...]

âš ï¸  è­¦å‘Šï¼šå³å°†åˆ é™¤ 1,234,567 æ¡ FeatureSnapshot è®°å½•ï¼
   æ­¤æ“ä½œä¸å¯é€†ï¼Œå»ºè®®å…ˆæ‰§è¡Œæ•°æ®åº“å¤‡ä»½ï¼š./scripts/pg_dump.sh

   ç¡®è®¤åˆ é™¤ï¼Ÿè¯·è¾“å…¥ 'DELETE' ç»§ç»­ï¼Œæˆ–æŒ‰ Enter å–æ¶ˆ: DELETE

ğŸ”„ å¼€å§‹åˆ é™¤ 1,234,567 æ¡è®°å½•ï¼ˆæ‰¹é‡å¤§å°: 10,000ï¼‰...
   Batch #1: å·²åˆ é™¤ 10,000/1,234,567 (0.8%)
   Batch #2: å·²åˆ é™¤ 20,000/1,234,567 (1.6%)
   Batch #3: å·²åˆ é™¤ 30,000/1,234,567 (2.4%)
   ...
   Batch #124: å·²åˆ é™¤ 1,234,567/1,234,567 (100.0%)

âœ… åˆ é™¤å®Œæˆï¼
   æ€»åˆ é™¤è®°å½•: 1,234,567
   æ€»æ‰¹æ¬¡æ•°: 124
   è€—æ—¶: 45.32 ç§’
   é€Ÿåº¦: 27,245 æ¡/ç§’

âœ… éªŒè¯é€šè¿‡ï¼šFeatureSnapshot è¡¨å·²å®Œå…¨æ¸…ç©º
```

---

## âš™ï¸ å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--execute` | flag | False | å®é™…æ‰§è¡Œåˆ é™¤ï¼ˆé»˜è®¤ä¸º dry-runï¼‰ |
| `--force` | flag | False | è·³è¿‡äºŒæ¬¡ç¡®è®¤ï¼ˆå±é™©ï¼ï¼‰ |
| `--batch-size` | int | 10000 | æ¯æ‰¹åˆ é™¤çš„è®°å½•æ•° |

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. åˆ é™¤å‰åŠ¡å¿…å¤‡ä»½

```bash
# å¦‚æœæœ‰å¤‡ä»½è„šæœ¬
./scripts/pg_dump.sh

# æˆ–ä½¿ç”¨ PostgreSQL å‘½ä»¤è¡Œå·¥å…·
pg_dump -h localhost -U your_user -d your_database -t AppleStockChecker_featuresnapshot > featuresnapshot_backup_$(date +%Y%m%d_%H%M%S).sql
```

### 2. åˆ é™¤æ“ä½œä¸å¯é€†

FeatureSnapshot è®°å½•åˆ é™¤åæ— æ³•æ¢å¤ï¼Œé™¤éä»å¤‡ä»½è¿˜åŸã€‚

### 3. ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å»ºè®®

- âœ… é€‰æ‹©ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œ
- âœ… æå‰é€šçŸ¥ç›¸å…³äººå‘˜
- âœ… ç¡®è®¤ä¾èµ–è¯¥æ•°æ®çš„æœåŠ¡å·²åœæ­¢
- âœ… å‡†å¤‡å›æ»šæ–¹æ¡ˆï¼ˆæ•°æ®åº“å¤‡ä»½ï¼‰

### 4. æ€§èƒ½è€ƒè™‘

- é»˜è®¤æ‰¹é‡å¤§å° 10,000 é€‚åˆå¤§å¤šæ•°åœºæ™¯
- å¦‚æœæ•°æ®åº“æ€§èƒ½è¾ƒå·®ï¼Œå¯é™ä½æ‰¹é‡å¤§å°ï¼ˆ`--batch-size 5000`ï¼‰
- å¦‚æœæ•°æ®åº“æ€§èƒ½å¾ˆå¥½ï¼Œå¯å¢å¤§æ‰¹é‡å¤§å°ï¼ˆ`--batch-size 20000`ï¼‰

### 5. ç›¸å…³æ“ä½œ

æ¸…ç©º FeatureSnapshot åï¼Œé€šå¸¸éœ€è¦é‡æ–°è¿è¡Œèšåˆä»»åŠ¡æ¥é‡æ–°ç”Ÿæˆæ•°æ®ï¼š

```bash
# è°ƒç”¨ API é‡æ–°ç”Ÿæˆç»Ÿè®¡æ•°æ®
curl -X POST http://localhost:8000/AppleStockChecker/purchasing-time-analyses/dispatch_ts/ \
  -H "Content-Type: application/json" \
  -d '{
    "timestamp_iso": "2025-12-11T14:00:00+09:00",
    "agg_minutes": 15,
    "agg_mode": "boundary",
    "force_agg": true
  }'
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æƒé™ä¸è¶³

```bash
# ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
chmod +x scripts/clear_feature_snapshots.py
chmod +x scripts/clear_feature_snapshots.sh
```

### é—®é¢˜ 2: Django ç¯å¢ƒé”™è¯¯

ç¡®ä¿é€šè¿‡ Docker å®¹å™¨è¿è¡Œï¼Œæˆ–è€…åœ¨æ­£ç¡®çš„ Python è™šæ‹Ÿç¯å¢ƒä¸­ã€‚

### é—®é¢˜ 3: åˆ é™¤é€Ÿåº¦æ…¢

- è°ƒæ•´ `--batch-size` å‚æ•°
- æ£€æŸ¥æ•°æ®åº“æ€§èƒ½å’Œè¿æ¥
- ç¡®è®¤æ²¡æœ‰å…¶ä»–è¿›ç¨‹é”è¡¨

### é—®é¢˜ 4: ä¸­æ–­æ¢å¤

å¦‚æœåˆ é™¤è¿‡ç¨‹è¢«ä¸­æ–­ï¼ˆCtrl+Cï¼‰ï¼Œéƒ¨åˆ†æ•°æ®å·²è¢«åˆ é™¤ï¼š
- é‡æ–°è¿è¡Œè„šæœ¬ä¼šç»§ç»­åˆ é™¤å‰©ä½™æ•°æ®
- æˆ–è€…ä½¿ç”¨ `--force` è·³è¿‡ç¡®è®¤ç›´æ¥åˆ é™¤å‰©ä½™æ•°æ®

---

## ğŸ“ æ—¥å¿—è®°å½•

è„šæœ¬è¾“å‡ºå¯ä»¥é‡å®šå‘åˆ°æ—¥å¿—æ–‡ä»¶ï¼š

```bash
./scripts/clear_feature_snapshots.sh --execute 2>&1 | tee clear_feature_snapshots_$(date +%Y%m%d_%H%M%S).log
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [CLAUDE.md](/home/user/YamagotiProjects/CLAUDE.md) - é¡¹ç›®å¼€å‘è§„èŒƒ
- [timestamp_alignment_task.py](/home/user/YamagotiProjects/AppleStockChecker/tasks/timestamp_alignment_task.py) - ç»Ÿè®¡æŒ‡æ ‡è®¡ç®—é€»è¾‘
- [api.py](/home/user/YamagotiProjects/AppleStockChecker/api.py) - è§¦å‘èšåˆä»»åŠ¡çš„ API

---

## ç‰ˆæœ¬å†å²

- `v1.0` (2025-12-11): åˆå§‹ç‰ˆæœ¬
  - æ”¯æŒ dry-run æ¨¡å¼
  - åˆ†æ‰¹åˆ é™¤
  - äºŒæ¬¡ç¡®è®¤æœºåˆ¶
  - è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
