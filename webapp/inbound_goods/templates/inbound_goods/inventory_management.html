<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在库商品管理</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .status-badge {
            font-size: 0.875rem;
            padding: 0.35em 0.65em;
        }
        .status-card {
            cursor: pointer;
            transition: all 0.2s;
        }
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .status-card.active {
            border-color: #0d6efd !important;
            box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25);
        }
        .table-hover tbody tr {
            cursor: pointer;
        }
        .selected-row {
            background-color: #e7f3ff !important;
        }
        .action-bar {
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            padding: 1rem 0;
            border-bottom: 2px solid #dee2e6;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <!-- 页面标题 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="bi bi-box-seam"></i> 在库商品管理
            </h1>
            <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInventoryModal">
                    <i class="bi bi-plus-circle"></i> 添加库存
                </button>
            </div>
        </div>

        <!-- 状态统计卡片 -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card status-card border-primary {% if not current_status %}active{% endif %}"
                     onclick="filterByStatus('')">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">全部</h6>
                        <h3 class="card-title mb-0">{{ total_count }}</h3>
                    </div>
                </div>
            </div>
            {% for status_code, status_info in status_stats.items %}
            <div class="col-md-3">
                <div class="card status-card {% if current_status == status_code %}active{% endif %}"
                     onclick="filterByStatus('{{ status_code }}')">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">{{ status_info.label }}</h6>
                        <h3 class="card-title mb-0">{{ status_info.count }}</h3>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- 搜索和过滤栏 -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">搜索</label>
                        <input type="text" class="form-control" name="q"
                               value="{{ search_query }}"
                               placeholder="商品编码、描述、备注...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">状态</label>
                        <select class="form-select" name="status">
                            <option value="">全部状态</option>
                            {% for status_code, status_label in status_choices %}
                            <option value="{{ status_code }}"
                                    {% if current_status == status_code %}selected{% endif %}>
                                {{ status_label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-5 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="bi bi-search"></i> 搜索
                        </button>
                        <a href="{% url 'inbound_goods:inventory_management' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-counterclockwise"></i> 重置
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- 批量操作栏 -->
        <div class="action-bar mb-3" id="bulkActionBar" style="display: none;">
            <div class="card">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        已选择 <strong id="selectedCount">0</strong> 项
                    </div>
                    <div>
                        <button class="btn btn-warning" onclick="bulkUpdateStatus()">
                            <i class="bi bi-pencil-square"></i> 批量更新状态
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearSelection()">
                            <i class="bi bi-x-circle"></i> 取消选择
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 库存列表 -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="40">
                                    <input type="checkbox" class="form-check-input" id="selectAll">
                                </th>
                                <th>商品编码</th>
                                <th>关联商品</th>
                                <th>状态</th>
                                <th>预订到货时间</th>
                                <th>特别描述</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for inventory in page_obj %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input inventory-checkbox"
                                           value="{{ inventory.id }}" data-unique-code="{{ inventory.unique_code }}">
                                </td>
                                <td>
                                    <strong>{{ inventory.unique_code }}</strong>
                                </td>
                                <td>
                                    {% if inventory.product %}
                                        {{ inventory.product }}
                                    {% else %}
                                        <span class="text-muted">未关联</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge status-badge
                                        {% if inventory.status == 'IN_STOCK' %}bg-success
                                        {% elif inventory.status == 'SHIPPED' %}bg-secondary
                                        {% elif inventory.status == 'PREPARING_SHIPMENT' %}bg-info
                                        {% elif inventory.status == 'STATUS_ABNORMAL' %}bg-danger
                                        {% else %}bg-warning{% endif %}">
                                        {{ inventory.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if inventory.reserved_arrival_time %}
                                        {{ inventory.reserved_arrival_time|date:"Y-m-d H:i" }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ inventory.special_description|truncatewords:10 }}</small>
                                </td>
                                <td>
                                    <small>{{ inventory.created_at|date:"Y-m-d H:i" }}</small>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary"
                                            onclick="viewDetail({{ inventory.id }})">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox fs-1"></i>
                                    <p>暂无库存记录</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                {% if page_obj.has_other_pages %}
                <nav aria-label="Page navigation" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if current_status %}&status={{ current_status }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}">
                                首页
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if current_status %}&status={{ current_status }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}">
                                上一页
                            </a>
                        </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">
                                第 {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} 页
                            </span>
                        </li>

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if current_status %}&status={{ current_status }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}">
                                下一页
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if current_status %}&status={{ current_status }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}">
                                末页
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 添加库存弹窗 -->
    <div class="modal fade" id="addInventoryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle"></i> 添加库存
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addInventoryForm">
                        <div class="mb-3">
                            <label class="form-label">商品类型 <span class="text-danger">*</span></label>
                            <select class="form-select" id="productType" required>
                                <option value="iphone">iPhone</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">选择商品 <span class="text-danger">*</span></label>
                            <select class="form-select" id="productSelect" required>
                                <option value="">请选择...</option>
                            </select>
                            <div class="form-text">
                                会动态加载可用商品列表
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">唯一商品编码 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="uniqueCode"
                                   placeholder="例如: IPN-MTUW3J-001" required
                                   pattern="^[A-Z0-9\-_]+$">
                            <div class="form-text">
                                只能包含大写字母、数字、连字符和下划线
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">在库状态 <span class="text-danger">*</span></label>
                            <select class="form-select" id="status" required>
                                {% for status_code, status_label in status_choices %}
                                <option value="{{ status_code }}">{{ status_label }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3" id="reservedArrivalTimeGroup" style="display: none;">
                            <label class="form-label">预订到货时间 <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="reservedArrivalTime">
                        </div>

                        <div class="mb-3" id="abnormalRemarkGroup" style="display: none;">
                            <label class="form-label">状态异常备注 <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="abnormalRemark" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">特别描述</label>
                            <textarea class="form-control" id="specialDescription" rows="3"
                                      placeholder="商品的特别说明或备注"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitAddInventory()">
                        <i class="bi bi-check-circle"></i> 创建
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量更新状态弹窗 -->
    <div class="modal fade" id="bulkUpdateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square"></i> 批量更新状态
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bulkUpdateForm">
                        <div class="mb-3">
                            <label class="form-label">已选择商品</label>
                            <div id="selectedItems" class="border rounded p-2 bg-light" style="max-height: 150px; overflow-y: auto;">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">新状态 <span class="text-danger">*</span></label>
                            <select class="form-select" id="bulkNewStatus" required>
                                {% for status_code, status_label in status_choices %}
                                <option value="{{ status_code }}">{{ status_label }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3" id="bulkReservedArrivalTimeGroup" style="display: none;">
                            <label class="form-label">预订到货时间</label>
                            <input type="datetime-local" class="form-control" id="bulkReservedArrivalTime">
                        </div>

                        <div class="mb-3" id="bulkAbnormalRemarkGroup" style="display: none;">
                            <label class="form-label">状态异常备注</label>
                            <textarea class="form-control" id="bulkAbnormalRemark" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">变更原因</label>
                            <textarea class="form-control" id="changeReason" rows="2"
                                      placeholder="批量状态更新"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-warning" onclick="submitBulkUpdate()">
                        <i class="bi bi-check-circle"></i> 确认更新
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 详情查看弹窗 -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle"></i> 库存详情
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailContent">
                    <div class="text-center py-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // 当前选中的库存 ID
        let selectedInventoryIds = [];

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载商品列表
            loadProducts();

            // 初始化条件字段显示状态（根据默认选中的状态）
            const initialStatus = document.getElementById('status').value;
            toggleConditionalFields(initialStatus, 'add');

            const initialBulkStatus = document.getElementById('bulkNewStatus').value;
            toggleConditionalFields(initialBulkStatus, 'bulk');

            // 监听状态变化（添加库存表单）
            document.getElementById('status').addEventListener('change', function() {
                toggleConditionalFields(this.value, 'add');
            });

            // 监听状态变化（批量更新表单）
            document.getElementById('bulkNewStatus').addEventListener('change', function() {
                toggleConditionalFields(this.value, 'bulk');
            });

            // 监听商品类型变化
            document.getElementById('productType').addEventListener('change', function() {
                loadProducts();
            });

            // 全选/取消全选
            document.getElementById('selectAll').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.inventory-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                });
                updateSelection();
            });

            // 单个复选框变化
            document.querySelectorAll('.inventory-checkbox').forEach(cb => {
                cb.addEventListener('change', updateSelection);
            });
        });

        // 根据状态显示/隐藏条件字段
        function toggleConditionalFields(status, formType) {
            const isReserved = ['CORPORATE_RESERVED_ARRIVAL', 'PERSONAL_RESERVED_ARRIVAL', 'PURCHASE_RESERVED_ARRIVAL'].includes(status);
            const isAbnormal = status === 'STATUS_ABNORMAL';

            if (formType === 'add') {
                document.getElementById('reservedArrivalTimeGroup').style.display = isReserved ? 'block' : 'none';
                document.getElementById('abnormalRemarkGroup').style.display = isAbnormal ? 'block' : 'none';
            } else if (formType === 'bulk') {
                document.getElementById('bulkReservedArrivalTimeGroup').style.display = isReserved ? 'block' : 'none';
                document.getElementById('bulkAbnormalRemarkGroup').style.display = isAbnormal ? 'block' : 'none';
            }
        }

        // 加载商品列表
        async function loadProducts() {
            const productType = document.getElementById('productType').value;
            const productSelect = document.getElementById('productSelect');

            try {
                const response = await fetch(`/inbound-goods/api/products/?type=${productType}`);
                const data = await response.json();

                if (data.success) {
                    productSelect.innerHTML = '<option value="">请选择...</option>';
                    data.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.part_number} - ${product.display_name}`;
                        option.dataset.contentTypeId = data.content_type_id;
                        productSelect.appendChild(option);
                    });
                } else {
                    alert('加载商品列表失败: ' + data.error);
                }
            } catch (error) {
                console.error('Error loading products:', error);
                alert('加载商品列表失败');
            }
        }

        // 提交添加库存表单
        async function submitAddInventory() {
            const form = document.getElementById('addInventoryForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const productSelect = document.getElementById('productSelect');
            const selectedOption = productSelect.options[productSelect.selectedIndex];

            const data = {
                unique_code: document.getElementById('uniqueCode').value,
                product_content_type: parseInt(selectedOption.dataset.contentTypeId),
                product_object_id: parseInt(productSelect.value),
                status: document.getElementById('status').value,
                special_description: document.getElementById('specialDescription').value,
            };

            // 条件字段
            const status = document.getElementById('status').value;
            if (['CORPORATE_RESERVED_ARRIVAL', 'PERSONAL_RESERVED_ARRIVAL', 'PURCHASE_RESERVED_ARRIVAL'].includes(status)) {
                data.reserved_arrival_time = document.getElementById('reservedArrivalTime').value;
            }
            if (status === 'STATUS_ABNORMAL') {
                data.abnormal_remark = document.getElementById('abnormalRemark').value;
            }

            try {
                const response = await fetch('/inbound-goods/api/inventory/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert('库存记录创建成功！');
                    location.reload();
                } else {
                    alert('创建失败: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating inventory:', error);
                alert('创建失败');
            }
        }

        // 更新选中状态
        function updateSelection() {
            const checkboxes = document.querySelectorAll('.inventory-checkbox:checked');
            selectedInventoryIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            const count = selectedInventoryIds.length;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('bulkActionBar').style.display = count > 0 ? 'block' : 'none';

            // 更新全选框状态
            const allCheckboxes = document.querySelectorAll('.inventory-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            selectAllCheckbox.checked = allCheckboxes.length > 0 && count === allCheckboxes.length;
        }

        // 清除选择
        function clearSelection() {
            document.querySelectorAll('.inventory-checkbox').forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('selectAll').checked = false;
            updateSelection();
        }

        // 打开批量更新弹窗
        function bulkUpdateStatus() {
            if (selectedInventoryIds.length === 0) {
                alert('请先选择要更新的商品');
                return;
            }

            // 显示已选择的商品
            const selectedItems = document.getElementById('selectedItems');
            const checkboxes = document.querySelectorAll('.inventory-checkbox:checked');
            selectedItems.innerHTML = '';
            checkboxes.forEach(cb => {
                const uniqueCode = cb.dataset.uniqueCode;
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary me-1 mb-1';
                badge.textContent = uniqueCode;
                selectedItems.appendChild(badge);
            });

            // 显示弹窗
            const modal = new bootstrap.Modal(document.getElementById('bulkUpdateModal'));
            modal.show();
        }

        // 提交批量更新
        async function submitBulkUpdate() {
            const form = document.getElementById('bulkUpdateForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                inventory_ids: selectedInventoryIds,
                new_status: document.getElementById('bulkNewStatus').value,
                change_reason: document.getElementById('changeReason').value || '批量状态更新',
                changed_by: 'admin'  // 可以从当前用户获取
            };

            // 条件字段
            const status = document.getElementById('bulkNewStatus').value;
            if (['CORPORATE_RESERVED_ARRIVAL', 'PERSONAL_RESERVED_ARRIVAL', 'PURCHASE_RESERVED_ARRIVAL'].includes(status)) {
                const time = document.getElementById('bulkReservedArrivalTime').value;
                if (time) {
                    data.reserved_arrival_time = time;
                }
            }
            if (status === 'STATUS_ABNORMAL') {
                const remark = document.getElementById('bulkAbnormalRemark').value;
                if (remark) {
                    data.abnormal_remark = remark;
                }
            }

            try {
                const response = await fetch('/inbound-goods/api/inventory/bulk-update/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`成功更新 ${result.updated_count} 条记录！`);
                    location.reload();
                } else {
                    alert('更新失败: ' + result.error);
                }
            } catch (error) {
                console.error('Error bulk updating:', error);
                alert('更新失败');
            }
        }

        // 查看详情
        async function viewDetail(inventoryId) {
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();

            try {
                const response = await fetch(`/inbound-goods/api/inventory/${inventoryId}/`);
                const data = await response.json();

                if (data.success) {
                    const inventory = data.inventory;
                    let html = `
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>商品编码:</strong> ${inventory.unique_code}
                            </div>
                            <div class="col-md-6">
                                <strong>关联商品:</strong> ${inventory.product_name}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>状态:</strong> <span class="badge bg-info">${inventory.status_display}</span>
                            </div>
                            <div class="col-md-6">
                                <strong>预订到货时间:</strong> ${inventory.reserved_arrival_time || '-'}
                            </div>
                        </div>
                        <div class="mb-3">
                            <strong>特别描述:</strong>
                            <p class="mb-0">${inventory.special_description || '-'}</p>
                        </div>
                        <div class="mb-3">
                            <strong>状态异常备注:</strong>
                            <p class="mb-0">${inventory.abnormal_remark || '-'}</p>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>创建时间:</strong> ${inventory.created_at}
                            </div>
                            <div class="col-md-6">
                                <strong>更新时间:</strong> ${inventory.updated_at}
                            </div>
                        </div>
                        <hr>
                        <h6>状态变更历史</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>时间</th>
                                        <th>旧状态</th>
                                        <th>新状态</th>
                                        <th>原因</th>
                                        <th>操作人</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    if (data.history.length > 0) {
                        data.history.forEach(record => {
                            html += `
                                <tr>
                                    <td><small>${record.changed_at}</small></td>
                                    <td><small>${record.old_status_display}</small></td>
                                    <td><small>${record.new_status_display}</small></td>
                                    <td><small>${record.change_reason}</small></td>
                                    <td><small>${record.changed_by || '-'}</small></td>
                                </tr>
                            `;
                        });
                    } else {
                        html += '<tr><td colspan="5" class="text-center">暂无历史记录</td></tr>';
                    }

                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;

                    document.getElementById('detailContent').innerHTML = html;
                } else {
                    document.getElementById('detailContent').innerHTML =
                        '<div class="alert alert-danger">加载失败: ' + data.error + '</div>';
                }
            } catch (error) {
                console.error('Error loading detail:', error);
                document.getElementById('detailContent').innerHTML =
                    '<div class="alert alert-danger">加载失败</div>';
            }
        }

        // 状态过滤
        function filterByStatus(status) {
            const url = new URL(window.location.href);
            if (status) {
                url.searchParams.set('status', status);
            } else {
                url.searchParams.delete('status');
            }
            url.searchParams.delete('page');  // 重置到第一页
            window.location.href = url.toString();
        }
    </script>
</body>
</html>
