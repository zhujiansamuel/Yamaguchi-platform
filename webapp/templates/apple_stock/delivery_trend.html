<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é€è¾¾å¤©æ•°è¶‹åŠ¿ï¼ˆæŒ‰ PN â†’ é—¨åº—ï¼‰</title>
  <!-- æ ·å¼ï¼šTailwind ä»…ä¸ºå¿«é€Ÿæ’ç‰ˆï¼Œå¯æ›¿æ¢ä¸ºä»»æ„æ–¹æ¡ˆ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- å›¾è¡¨ï¼šChart.jsï¼ˆé›¶ä¾èµ–ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // ç®€æ˜“æš—è‰²æ¨¡å¼
    (()=>{const pref=localStorage.getItem('theme')||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');if(pref==='dark')document.documentElement.classList.add('dark');window.__toggleTheme=()=>{document.documentElement.classList.toggle('dark');localStorage.setItem('theme',document.documentElement.classList.contains('dark')?'dark':'light');};})();
  </script>
  <style>
    *{scrollbar-width:thin}::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px}.dark ::-webkit-scrollbar-thumb{background:#334155}
  </style>
</head>
<body class="bg-zinc-50 text-zinc-900 dark:bg-zinc-900 dark:text-zinc-50 min-h-screen">
  <div class="max-w-7xl mx-auto p-4 space-y-4">
    <header class="flex items-center gap-3">
      <h1 class="text-xl font-semibold">é€è¾¾å¤©æ•°è¶‹åŠ¿ï¼ˆæŒ‰ PN â†’ é—¨åº—ï¼‰</h1>
      <button class="ml-auto p-2 rounded hover:bg-zinc-100 dark:hover:bg-zinc-800" title="åˆ‡æ¢ä¸»é¢˜" onclick="__toggleTheme()">ğŸŒ“</button>
    </header>

    <!-- æŸ¥è¯¢æ  -->
    <section class="rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-3">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">iPhone å”¯ä¸€ç¼–ç ï¼ˆPNï¼‰</label>
          <input id="pnInput" list="pnOptions" type="text" placeholder="å¦‚ï¼šMTUW3J/A"
                 class="w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 outline-none"/>
          <datalist id="pnOptions"></datalist>
          <p class="text-xs text-zinc-500 mt-1">ä»ä¸‹æ‹‰å»ºè®®é€‰æ‹©æˆ–è¾“å…¥å®Œæ•´ PNã€‚</p>
        </div>
        <div>
          <label class="block text-sm mb-1">æœ€è¿‘ N å¤©</label>
          <input id="daysInput" type="number" min="1" max="90" value="14"
                 class="w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 outline-none"/>
        </div>
        <div class="flex items-center gap-2">
          <input id="onlyNonZero" type="checkbox" class="w-4 h-4"/>
          <label for="onlyNonZero" class="text-sm">ä»…æ˜¾ç¤ºé 0 å¤©æ•°ç‚¹</label>
        </div>
        <div class="flex items-center gap-2 md:justify-end">
          <button id="refreshBtn" class="px-3 py-2 bg-black text-white dark:bg-white dark:text-black rounded-lg">æŸ¥è¯¢</button>
          <span id="loading" class="text-sm text-zinc-600 dark:text-zinc-400 hidden">åŠ è½½ä¸­â€¦</span>
        </div>
      </div>
      <p class="text-xs text-zinc-500 mt-2">è§„åˆ™ï¼šå¤©æ•° = ceil(é€è¾¾æ—¥æœŸ âˆ’ è®°å½•æ—¥æœŸ)ã€‚è‹¥æ— åº“å­˜æˆ–é€è¾¾æ—¶é—´ç¼ºå¤±ï¼Œåˆ™å– 0ã€‚æŒ‰å¤©èšåˆï¼ˆåŒåº—åŒæ—¥ï¼‰æ—¶ï¼šæœ€æ—©å–æœ€å°ã€æœ€æ™šå–æœ€å¤§ï¼›ä¸­ä½æ•° = round((æœ€æ—©+æœ€æ™š)/2)ã€‚</p>
    </section>

    <!-- PN åŸºæœ¬ä¿¡æ¯ï¼ˆå¯é€‰å±•ç¤ºï¼‰ -->
    <section id="pnMeta" class="hidden rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 p-3 text-sm"></section>

    <!-- å›¾è¡¨å®¹å™¨ï¼ˆæ¯å®¶åº—ä¸€å¼ å›¾ï¼‰ -->
    <section id="chartsWrap" class="space-y-6"></section>

    <footer class="text-xs text-zinc-500">æ•°æ®æ¥æºï¼š/AppleStockChecker/inventory-records/trend?pn=â€¦ï¼ˆåç«¯èšåˆï¼‰ï¼›PN åˆ—è¡¨æ¥è‡ª /AppleStockChecker/iphones/</footer>
  </div>

<script>
const apiBase = '/AppleStockChecker';
const $ = sel => document.querySelector(sel);
let charts = [];

function esc(s){return (s??'').toString().replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));}

async function fetchAll(url, maxPages=20){
  const out=[]; let next=url, page=0;
  while(next && page<maxPages){
    const r=await fetch(next); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    const j=await r.json(); page++;
    if(Array.isArray(j)) return j; // æ— åˆ†é¡µæ¨¡å¼
    out.push(...(j.results||[])); next=j.next;
  }
  return out;
}

// è½½å…¥ PN å»ºè®®ï¼ˆvalue=PNï¼Œlabel=å‹å·+å®¹é‡+é¢œè‰²ï¼‰
async function loadPnOptions(){
  try{
    const rows = await fetchAll(`${apiBase}/iphones/?ordering=model_name`);
    const html = rows.map(x => {
      const cap = (x.capacity_gb % 1024 === 0) ? (x.capacity_gb/1024 + 'TB') : (x.capacity_gb + 'GB');
      return `<option value="${esc(x.part_number)}">${esc(x.model_name)} ${esc(cap)} ${esc(x.color)}</option>`;
    }).join('');
    $('#pnOptions').innerHTML = html;
  }catch{}
}

// è°ƒåç«¯èšåˆæ¥å£ï¼ˆæŒ‰ PN â†’ é—¨åº—ï¼‰
async function queryTrendByPN(pn, days){
  if(!pn) throw new Error('è¯·è¾“å…¥ PN');
  const p = new URLSearchParams({ pn: pn.trim(), days: String(Math.max(1, days|0)) });
  const res = await fetch(`${apiBase}/inventory-records/trend/?${p.toString()}`);
  if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  return await res.json(); // { part_number, iphone, stores: [...] }
}

function destroyCharts(){ charts.forEach(c=>c?.destroy()); charts=[]; }

function renderPnMeta(meta){
  const box = $('#pnMeta');
  if(!meta){ box.classList.add('hidden'); box.innerHTML=''; return; }
  const cap = (meta.capacity_gb % 1024 === 0) ? (meta.capacity_gb/1024 + 'TB') : (meta.capacity_gb + 'GB');
  box.innerHTML = `
    <div class="flex items-center gap-4">
      <div><span class="text-zinc-500">PNï¼š</span><span class="font-mono">${esc(meta.part_number)}</span></div>
      <div><span class="text-zinc-500">å‹å·ï¼š</span>${esc(meta.model_name)}</div>
      <div><span class="text-zinc-500">è§„æ ¼ï¼š</span>${esc(cap)} ${esc(meta.color)}</div>
      <div><span class="text-zinc-500">ä¸Šå¸‚ï¼š</span>${esc(meta.release_date || '-')}</div>
    </div>`;
  box.classList.remove('hidden');
}

function renderChartsFromResponse(resp, onlyNonZero){
  const wrap = $('#chartsWrap');
  wrap.innerHTML = '';
  destroyCharts();

  renderPnMeta(resp.iphone);

  const stores = resp.stores || [];
  if(!stores.length){
    wrap.innerHTML = '<div class="p-3 text-zinc-500">æœªæ‰¾åˆ°æ•°æ®ï¼Œå°è¯•æ›´æ¢ PN æˆ–æ”¾å®½æ—¶é—´èŒƒå›´ã€‚</div>';
    return;
  }

  for(const s of stores){
    let labels = s.dates || [];
    let E = s.earliest || [], M = s.median || [], L = s.latest || [];

    if(onlyNonZero){
      const idx=[]; for(let i=0;i<labels.length;i++){ if((E[i]||0)!==0 || (M[i]||0)!==0 || (L[i]||0)!==0) idx.push(i); }
      labels=idx.map(i=>labels[i]); E=idx.map(i=>E[i]); M=idx.map(i=>M[i]); L=idx.map(i=>L[i]);
    }

    const card=document.createElement('div');
    card.className='rounded-2xl border border-zinc-200 dark:border-zinc-800 overflow-hidden';
    card.innerHTML=`
      <div class="p-3 bg-zinc-100 dark:bg-zinc-900/50 flex items-center gap-3">
        <div class="min-w-0">
          <div class="font-medium truncate">${esc(s.name)}</div>
          <div class="text-xs text-zinc-600 dark:text-zinc-400 truncate">${esc(s.address||'')}</div>
        </div>
        <div class="ml-auto text-xs text-zinc-600 dark:text-zinc-400">ç‚¹æ•°ï¼š${labels.length}</div>
      </div>
      <div class="p-3"><canvas id="chart-${s.id}"></canvas></div>`;
    wrap.appendChild(card);

    const ctx = document.getElementById(`chart-${s.id}`).getContext('2d');
    const chart = new Chart(ctx,{
      type:'line',
      data:{ labels, datasets:[
        { label:'æœ€æ—©åˆ°è¾¾ï¼ˆå¤©ï¼‰', data:E, tension:0.2 },
        { label:'ä¸­ä½æ•°ï¼ˆå¤©ï¼‰', data:M, borderDash:[6,4], tension:0.2 },
        { label:'æœ€æ™šåˆ°è¾¾ï¼ˆå¤©ï¼‰', data:L, tension:0.2 },
      ]},
      options:{
        responsive:true,
        interaction:{mode:'index', intersect:false},
        plugins:{ legend:{position:'top'}, tooltip:{ callbacks:{ label:(it)=> `${it.dataset.label}: ${it.formattedValue} å¤©` } } },
        scales:{ x:{ title:{display:true,text:'è®°å½•æ—¥æœŸ'} }, y:{ beginAtZero:true, title:{display:true,text:'é€è¾¾å¤©æ•°ï¼ˆå¤©ï¼‰'}, ticks:{stepSize:1} } }
      }
    });
    charts.push(chart);
  }
}

async function run(){
  const loading=$('#loading'); loading.classList.remove('hidden');
  try{
    const pn = ($('#pnInput').value||'').trim();
    const days = Math.max(1, parseInt($('#daysInput').value||'14',10));
    const onlyNonZero = $('#onlyNonZero').checked;

    const resp = await queryTrendByPN(pn, days);
    renderChartsFromResponse(resp, onlyNonZero);
  }catch(e){
    $('#chartsWrap').innerHTML = `<div class="p-3 rounded-lg bg-red-50 text-red-700">åŠ è½½å¤±è´¥ï¼š${esc(e.message||e)}</div>`;
    renderPnMeta(null);
  }finally{ loading.classList.add('hidden'); }
}

// äº‹ä»¶
$('#refreshBtn').addEventListener('click', run);
$('#pnInput').addEventListener('keydown', e=>{ if(e.key==='Enter') run(); });

// åˆå§‹åŒ–
loadPnOptions();
</script>
</body>
</html>
