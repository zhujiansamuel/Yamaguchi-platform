
http://127.0.0.1:8080/AppleStockChecker/auth/token/
http://127.0.0.1:8080/AppleStockChecker/import-iphone-csv/
http://127.0.0.1:8080/AppleStockChecker/delivery-trend/
http://127.0.0.1:8080/AppleStockChecker/dashboard/
http://127.0.0.1:8080/AppleStockChecker/store-latest/
http://127.0.0.1:8080/AppleStockChecker/resale-trend-pn-merged/
http://127.0.0.1:8080/AppleStockChecker/external-ingest/

/admin/easyaudit/crudevent/
/admin/easyaudit/loginevent/
/admin/easyaudit/requestevent/

docker run -d --name redis  -p 6379:6379  -e REDIS_ARGS="--appendonly yes --save 900 1 --save 300 10"  redis:7-alpine
celery -A YamagotiProjects worker -l info
celery -A YamagotiProjects worker -l info -P solo --concurrency=1


http://localhost:8080/AppleStockChecker/auth/token/



git clone https://github.com/zhujiansamuel/YamagotiProjects.git src
scp ./db.sqlite3 root@47.111.136.177:/opt/apple/db/db.sqlite3


说明 & 可调参数汇总

平均线 3 条默认值在 AVG_LINES_DEFAULTS 中集中定义：

const AVG_LINES_DEFAULTS = [
  { id:'A', label:'平均线 A', bucketMinutes:30,  lineWidth:3, color:'#000000', dash:'solid', shops:'ALL' },
  { id:'B', label:'平均线 B', bucketMinutes:60,  lineWidth:2, color:'#ff0077', dash:'dash',  shops:'ALL' },
  { id:'C', label:'平均线 C', bucketMinutes:1440,lineWidth:2, color:'#00bcd4', dash:'dot',   shops:'ALL' },
];




  模式 B：内联构建（shop 4, 7）

  - 没有独立函数，在 clean_shop*() 里直接用 for 循环构建
  - value 更简单，只存 part_number，不保留 color_raw

  模式 C：JAN 条码匹配（shop 1, 18）

  - 通过 JAN（条码数字）直接映射到 part_number
  - shop18 额外提供 (model, cap, color) 三元组作为 fallback

  模式 D：无预构建（shop 2, 9, 13）

  - shop2：直接对 info_df 做 pandas filter
  - shop9：_build_color_aliases() 只是同义词辅助，不是主查找表
  - shop13：用 groupby 聚合，返回每个 (model, cap) 下的 PN 列表








git fetch --all --prune
git reset --hard origin/master
git pull origin master

MG8F4J/A

git fetch --all --prune
git checkout master
git reset --hard origin/master
docker compose build
docker compose up -d web nginx

Y9Rs5xPkZQjcYHJ

---------------------------------------------------------------------
docker compose --profile shop-workers restart worker_shop17
---------------------------------------------------------------------

docker compose --profile celery --profile shop-workers restart

---------------------------------------------------------------------
---------------------------------------------------------------------
cd /opt/apple/src            # 换成你实际路径

git checkout temp-deploy-claude
git reset --hard             # 丢弃服务器上的本地修改

git fetch origin claude/project-summary-011CyeDS1H9X98GJde4jbr5e
git reset --hard FETCH_HEAD  # 同步到远程 claude 的最新提交

git log -1 --oneline         # 看一下当前版本（可选）

docker compose build && docker compose up -d --scale worker=5

docker compose up -d
---------------------------------------------------------------------
docker compose up -d \
  --scale worker_webscraper=3 \
  --scale worker=10


docker compose up -d --scale worker=5


docker compose logs -f web
docker compose logs -f celery
docker compose logs -f nginx

docker compose up -d --scale worker=6


sudo tee /etc/systemd/system/ngrok.service >/dev/null <<'UNIT'
[Unit]
Description=ngrok (custom domains -> localhost)
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/ngrok start app metabase mindsdb --config=/root/.config/ngrok/ngrok.yml --region=jp
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
UNIT



docker ps -a
docker logs -f apple-web-1 --tail 200

docker logs -f apple-nginx-1 --tail 200

https://api.webscraper.io/api/v1/scraping-jobs?sitemap_id=1367906&api_token=



localStorage.setItem('iphone:token', ' ;

localStorage.setItem('iphone:token', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzYwOTUyNDYzLCJpYXQiOjE3NjA5NTA2NjQsImp0aSI6ImMwYjJiMmI3YTM1OTRiNDJhYWM2YWFhYmVjMjhhNTkxIiwidXNlcl9pZCI6IjEifQ.MFVyUl1IYMOVILX2nAYyKPWs4R3Sr9FYaoIznAOC2GA');



brew services start redis
python manage.py runserver 127.0.0.1:8000
celery -A YamagotiProjects worker -l info
celery -A YamagotiProjects beat -l info

celery -A YamagotiProjects flower --port=5555


celery -A YamagotiProjects beat -l info --scheduler 

django_celery_beat.schedulers:DatabaseScheduler


celery -A YamagotiProjects worker -l info -P threads --concurrency=8

celery -A YamagotiProjects worker -l info -P eventlet --concurrency=15
daphne -b 0.0.0.0 -p 8000 YamagotiProjects.asgi:application

--------------------------------------------
ACCESS="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzYwOTU0Njk5LCJpYXQiOjE3NjA5NTI4OTksImp0aSI6IjgyOThjMDE3Zjk0NDQyMGU4YzliZWQ4ZjVhNzY0M2Y2IiwidXNlcl9pZCI6IjEifQ.R_V82ZJAx_d7YuNKoWP3K8XQZ7apLx81GiTNIdu0XYs"
noglob websocat -t \
  -H='Origin: https://yamaguti.ngrok.io' \
  -H="Authorization: Bearer $ACCESS" \
  "wss://yamaguti.ngrok.io/ws/stream/psta/?token=$ACCESS"
--------------------------------------------
ACCESS="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzYwOTI1OTM0LCJpYXQiOjE3NjA5MjQxMzQsImp0aSI6ImRiMjBiYjdiZTYxMzRlNjA4ZTgyYTk1NjQ2MmY4NGI4IiwidXNlcl9pZCI6IjEifQ.pNPnkVH1nnMfxJlcEPrOufFGkuPJzNN9lpJ2Ys9w0fM"

noglob websocat -t \
  -H='Origin: https://127.0.0.1' \
  -H="Authorization: Bearer $ACCESS" \
  "wss://127.0.0.1/ws/stream/psta/?token=$ACCESS"




shop1---->ok
shop2---->ok
shop3---->ok
shop4---->ok
shop5---->ok
shop6---->ok
shop7---->取得数据有问题，颜色待修改
shop8---->ok
shop9---->ok
shop10--->ok
shop11--->403，原因未明
shop12--->ok
shop13--->ok
shop14--->ok
shop15--->减价信息在价格栏
shop16--->ok
shop18--->ok
shop20--->ok

https://verbless-sadistically-jayceon.ngrok-free.dev/AppleStockChecker/purchasing-time-analyses-psta-compact/?start=2025-10-11T00:00:00%2B09:00&end=2025-10-13T00:00:00%2B09:00


docker compose build
docker compose run --rm -v "$PWD":/app web python manage.py makemigrations AppleStockChecker
docker compose run --rm -v "$PWD":/app web python manage.py makemigrations AppleStockChecker

docker compose run --rm -v "$PWD":/app -w /app web bash -lc '
  unset DB_HOST DB_PORT DB_NAME DB_USER DB_PASSWORD && \
  python manage.py dumpdata \
    --natural-foreign --natural-primary \
    -e contenttypes -e admin.logentry -e sessions -e auth.permission \
    --indent 2 > /app/sqlite_data.json
'

docker compose run --rm web bash -lc '
  unset DB_HOST DB_PORT DB_NAME DB_USER DB_PASSWORD;
  python manage.py dumpdata \
    --natural-foreign --natural-primary \
    -e contenttypes -e admin.logentry -e sessions -e auth.permission \
    --indent 2 > /app/sqlite_data.json
'

docker compose run --rm web bash -lc '
  python manage.py dumpdata \
    --database=sqlite_old \
    --natural-foreign --natural-primary \
    -e contenttypes -e admin.logentry -e sessions -e auth.permission \
    --indent 2 > sqlite_data.json'




docker compose run --rm web bash -lc '
  python manage.py loaddata /app/sqlite_data.json
'



CREATE USER samuelzhujian WITH PASSWORD 'Xdb73008762' LOGIN;
CREATE DATABASE yappdb OWNER samuelzhujian ENCODING 'UTF8';
GRANT ALL PRIVILEGES ON DATABASE yappdb TO samuelzhujian;
\q

export SQLITE_PATH="/Users/syu/PycharmProjects/YamagotiProjects/db.sqlite3"
export PG_URL="postgresql://samuelzhujian:Xdb73008762@localhost:5432/yappdb"


docker compose exec -T db bash -lc 'psql -U "$POSTGRES_USER" -d yappdb -c "\dt"'

export DATABASE_URL="postgresql://samuelzhujian:Xdb73008762@127.0.0.1:5432/yappdb"

docker compose exec -T db bash psql "postgresql://samuelzhu:Xdb73008762@127.0.0.1:5432/yappdb" -c "\dt"

docker compose exec -T db bash -lc 'psql "postgresql://samuelzhu:Xdb73008762@127.0.0.1:5432/yappdb" -c "\dt" '


psql "postgresql://samuelzhujian:Xdb73008762@127.0.0.1:5432/yappdb" -c "\dt"

psql "postgresql://samuelzhujian:Xdb73008762@127.0.0.1:5432/yappdb"


celery -A YamagotiProjects worker -l info -P threads --concurrency=8


brew services start postgresql@16


ALTER TABLE applestockchecker_inventoryrecord RENAME TO "Applestockchecker_inventoryrecord";
ALTER TABLE applestockchecker_iphone RENAME TO "Applestockchecker_iphone";
ALTER TABLE applestockchecker_officialstore RENAME TO "Applestockchecker_officialstore";
ALTER TABLE applestockchecker_purchasingshoppricerecord RENAME TO "Applestockchecker_purchasingshoppricerecord";
ALTER TABLE applestockchecker_purchasingshoptimeanalysis RENAME TO "Applestockchecker_purchasingshoptimeanalysis";
ALTER TABLE applestockchecker_secondhandshop RENAME TO "Applestockchecker_secondhandshop";








celery -A YamagotiProjects beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler




pkill -f 'celery worker' ; celery -A YamagotiProjects worker -l info --concurrency=15




http POST :8000/AppleStockChecker/dispatch-psta-batch-same-ts \
  items:='[
    {"shop_id":1,"iphone_id":2,"Original_Record_Time_Zone":"+09:00","Timestamp_Time_Zone":"+09:00",
     "Record_Time":"2025-10-10T17:30:00+09:00","Alignment_Time_Difference":0,"New_Product_Price":211000}
  ]'

curl -X POST http://127.0.0.1:8000/AppleStockChecker/purchasing-time-analyses/dispatch_ts/\
  -H 'Content-Type: application/json' \
  -d '{"timestamp_iso":"2025-10-10T17:30:00+09:00"}'


curl -X POST http://127.0.0.1:8000/AppleStockChecker/dispatch-psta-batch-same-ts \
     -H "Content-Type: application/json" \
     -d '{
       "items":[
         {"shop_id":1,"iphone_id":2,"Original_Record_Time_Zone":"+09:00","Timestamp_Time_Zone":"+09:00",
          "Record_Time":"2025-10-10T17:30:00+09:00","Alignment_Time_Difference":0,"New_Product_Price":211000},
         {"shop_id":2,"iphone_id":3,"Original_Record_Time_Zone":"+09:00","Timestamp_Time_Zone":"+09:00",
          "Record_Time":"2025-10-10T17:30:00+09:00","Alignment_Time_Difference":0,"New_Product_Price":198000}
       ]
     }'



curl -X POST "http://127.0.0.1:8000/AppleStockChecker/purchasing-time-analyses/dispatch_ts/" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzYwMDg5OTY0LCJpYXQiOjE3NjAwODgxNjQsImp0aSI6IjhiMWM1YmNjODJkMzQ1ZTY4MjI0YzBkOTliMjQ1M2ZkIiwidXNlcl9pZCI6IjEifQ.0wuipdD3kugCuI1Lbqyk6I_Y9lYT1dog6UctXIGu3f0" \
  -d '{
    "items": [
      {"shop_id":1,"iphone_id":2,"Original_Record_Time_Zone":"+09:00","Timestamp_Time_Zone":"+09:00",
       "Record_Time":"2025-10-10T18:30:00+09:00","Alignment_Time_Difference":0,"New_Product_Price":211000}
    ]
  }'


curl -X POST "http://127.0.0.1:8000/AppleStockChecker/purchasing-time-analyses/dispatch_ts/"


curl -X POST http://127.0.0.1:8000/AppleStockChecker/purchasing-time-analyses/dispatch_ts/\
  -H 'Content-Type: application/json' \
  -d '{"timestamp_iso":"2025-10-10T17:30:00+09:00"}'




curl -i -X POST \
  "http://127.0.0.1:8000/AppleStockChecker/purchasing-price-records/import-tradein-xlsx/?dry_run=0" \
  -H "Authorization: Bearer ${ACCESS}" \
  -F "files=@/Users/syu/Downloads/shop2.xlsx"


curl -i -X POST \
  "http://yamaguti.ngrok.io/AppleStockChecker/purchasing-price-records/import-tradein-xlsx/?dry_run=0" \
  -H "Authorization: Bearer ${ACCESS}" \
  -F "files=@/Users/syu/Downloads/shop2.xlsx"






curl -i "https://verbless-sadistically-jayceon.ngrok-free.dev/AppleStockChecker/purchasing-time-analyses-psta-compact/?start=2025-10-11T00:00:00%2B09:00&end=2025-10-13T00:00:00%2B09:00"\
  -H "Accept: application/json" \
  -H "ngrok-skip-browser-warning: 1"






https://verbless-sadistically-jayceon.ngrok-free.dev/AppleStockChecker/purchasing-time-analyses-psta-compact/?start=2025-10-10T09:00:00%2B09:00&end=2025-10-11T20:00:00%2B09:00&shop=11&iphone__jan=4549995648300



docker compose run --rm \
  -e DJANGO_SUPERUSER_USERNAME=samuelzhu \
  -e DJANGO_SUPERUSER_EMAIL=samuel201111@gmail.com \
  -e DJANGO_SUPERUSER_PASSWORD='Xdb73008762' \
  web python manage.py createsuperuser --noinput



curl -v --max-time 600 \
  -H "Authorization: Bearer ${ACCESS}" \
  -F "files=@/Users/syu/PycharmProjects/YamagotiProjects/WebScraperData/shop18/shop18.xlsx" \
  "https://yamaguti.ngrok.io/AppleStockChecker/purchasing-price-records/import-tradein-xlsx/?dry_run=0"



curl -I http://yamaguti.ngrok.io/AppleStockChecker/static/admin/simplepro/images/bg.svg

curl -i https://yamaguti.ngrok.io/AppleStockChecker/static/admin/simplepro/images/bg.svg



recorded_after
recorded_before

https://yamaguti.ngrok.io/AppleStockChecker/purchasing-price-records/?recorded_after= & recorded_before=

https://yamaguti.ngrok.io/AppleStockChecker/purchasing-time-analyses/psta-compact/?start=2025-10-01T10%3A00%3A00%2B09%3A00&end=2025-10-20T10%3A00%3A00%2B09%3A00&shop=13&iphone__part_number=MG854J%2FA

<!-- ================= iPhone 17 Pro Max ================= -->

....

<tr data-color="blue">....
<tr data-color="silver">....
<!-- 512GB -->
<tr>...
<tr class="avg-row" data-color="all">....
<tr data-color="orange">....
<tr data-color="blue">....
<tr data-color="silver">....
<!-- 1TB -->
<tr>...
<tr class="avg-row" data-color="all">....
<tr data-color="orange">....
<tr data-color="blue">....
<tr data-color="silver">....
<!-- 2TB -->
<tr>...
<tr class="avg-row" data-color="all">....
<tr data-color="orange">....
<tr data-color="blue">....
<tr data-color="silver">....

....
<!-- ================= iPhone 17 Pro ================= -->
....
<tr data-color="blue">....
<tr data-color="silver">....
<!-- 512GB -->
<tr>...
<tr class="avg-row" data-color="all">....
<tr data-color="orange">....
<tr data-color="blue">....
<tr data-color="silver">....
<!-- 1TB -->
<tr>...
<tr class="avg-row" data-color="all">....
<tr data-color="orange">....
<tr data-color="blue">....
<tr data-color="silver">....


curl -X POST https://verbless-sadistically-jayceon.ngrok-free.dev/AppleStockChecker/post-to-x/ \
     -H "Content-Type: application/json" \
     -d '{"base64Image": "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI5gAAAABJRU5ErkJggg==", "caption": "Test post"}'




スマホ、ゲーム機等の買取価格を監視しています。毎日10:30〜18:30頃に配信します。対象店舗は固定ポストをご参照ください。 #iPhone17買取相場 / #iPhone16買取相場 / #iPhone15買取相場 / #Android買取相場 / #Pixel買取相場 / #Game買取相場

#iPhone17買取相場
#iPhone17買取相場20251024
最終更新日時：2025/10/24（金）12時00分

curl "https://docs.google.com/spreadsheets/d/e/2PACX-1vTHgVMpH0FnvdAmk2sqEUVkexuuo5oA5XNZTaTbCMGMpy8HSK3TImgQviU99UX-STS4B4IuNrnYG7Sz/pubhtml?gid=1011791912&single=true&range=A1:B152&widget=false&headers=false&chrome=false"


https://docs.google.com/spreadsheets/d/e/2PACX-1vTHgVMpH0FnvdAmk2sqEUVkexuuo5oA5XNZTaTbCMGMpy8HSK3TImgQviU99UX-STS4B4IuNrnYG7Sz/pubhtml?gid=1011791912&single=true&range=A1:B152&widget=false&headers=false&chrome=false

SHOP_DISPLAY_ORDER = [
    "買取商店",
    "海峡通信",  # shop2　　　      ２
    "買取一丁目",  # shop3         ３
    "モバイルミックス",  # shop4         4
    "森森買取",  # shop5           ５
    "買取ルデヤ",  # shop6         ６
    "買取wiki",  # shop8          ７
    "買取ホムラ",  # shop7         ８
    "ドラゴンモバイル",  # shop10　　９
    "モバステ",  # shop11　         10
    "アキモバ",  # shop9           11
    "トゥインクル",  # shop12        12
    "家電市場",  # shop13           13
    "買取楽園",  # shop14           14
    "買取当番",  # shop15           15
    "携帯空間",  # shop16           16
    "ゲストモバイル",  # shop17               17
    "買取オク",  # shop18               18
    "毎日買取",  # shop20           20
]

買取商店 part_number  #shop1
森森買取 part_number  # shop5
買取ルデヤ part_number # shop6
買取Wiki part_number  # shop8
家電市場 part_number  # shop13
毎日買取 part_number  # shop20

買取商店	          part_number  #shop1
海峡通信           1
買取一丁目          1
モバイルミックス     1
森森買取	          part_number  # shop5
買取ルデヤ	      part_number # shop6
買取Wiki	          part_number  # shop8
買取ホムラ         2
ドラゴンモバイル
モバステ           1
アキモバ           1
トゥインクル        1
家電市場	          part_number  # shop13
買取楽園           1
携帯空間           1
ゲストモバイル      1
毎日買取	          part_number  # shop20
MobileZone


https://docs.google.com/spreadsheets/d/e/2PACX-1vTHgVMpH0FnvdAmk2sqEUVkexuuo5oA5XNZTaTbCMGMpy8HSK3TImgQviU99UX-STS4B4IuNrnYG7Sz/pubhtml?gid=1011791912

アキモバ
トゥインクル
携帯空間
ドラゴンモバイル

                <th class="shop-col shop-head shop-買取ホムラ">買取<br>ホムラ
                <th class="shop-col shop-head shop-ドラゴンモバイル-">ドラゴン<br>モバイル



git switch -c feature/psta-overallbar-cohortbar
git commit -m "开始主攻统计信息"
git push -u origin feature/psta-overallbar-cohortbar

